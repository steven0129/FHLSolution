<!DOCTYPE html>
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta property="og:title" content="信望愛聖經工具" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://bkbible.fhl.net/~sean/bible/index.html" />
  <meta property="og:image" content="static/images/FHLLOGO.png" />
  <meta property="og:site_name" content="FHL信望愛聖經工具" />
  <meta property="og:description" content="" />

  <!-- 第3方函式庫, 統一 include: jquery/jqueryUI, react, linq, vue-->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <!--<script>
      $.ajax({
      url: '/Scripts/jquery-ui.js',
      dataType: "script",
      async: false
      });
  </script>-->
  <style type="text/css">
    .bstw {
      font-family: "bstw";
    }

    @font-face {
      font-family: "bstw";
      src: url("static/font/open_han.ttf") format("trueType"), url("static/font/open_han.woff2") format("woff2"), url("static/font/open_han.svg") format("svg"), url("static/font/open_han.woff") format("woff");
    }
  </style>


  <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">

  <script src="static/libs/react/react-0.13.1.min.js"></script>

  <script src="static/libs/linq.js_ver2.2.0.2/linq.min.js"></script>
  <script src="static/libs/linq.js_ver2.2.0.2/jquery.linq.min.js"></script>
  <script src="static/Scripts/vue.js"></script>

  <script src="static/Scripts/FHL/FHL.js"></script>
  <script src="static/Scripts/FHL/CONSTANT/bible-constants.js"></script>
  <script src="static/Scripts/FHL/STR/eachFitDo.js"></script>
  <script src="static/Scripts/FHL/NET/UrlParameter.js"></script>
  <script src="static/Scripts/FHL/FhlUrlParameter.js"></script>


  <title>信望愛聖經工具</title>
  <link rel="shortcut icon" href="static/images/FHLLOGO.ico" type="image/x-icon" />

  <link rel="stylesheet" href="static/libs/fhl.css" />
  <link rel="stylesheet" href="static/libs/icons/css/font-awesome.css" />


  <script src="static/libs/jquery.hotkeys.js"></script>

  <!-- 2017.07 將新版NUI常數納入,並統一用法 -->
  <!--2015.09.02(三) snow add. React lib (可以共用的react))-->
  <script src="static/commonR/processbar.js"></script><!--緣由:講道-->
  <script src="static/commonR/audio.js"></script><!--緣由:講道-->
  <!-- 2015.09.24(四) snow add. obphp lib -->
  <link href="static/ob_api/ob_api.css" rel="stylesheet" />
  <link href="static/ob_api/ob_table.css" rel="stylesheet" />
  <script src="static/ob_api/obphp.js"></script>
  <!--搜尋結果上色要用的 2015.10.29(四)-->
  <script src="static/search_api/sephp.react.txt.txtSn.js"></script>
  <!--Start of 搜尋功能-->

  <script src="static/search_api/abvphp_api.js"></script>
  <script src="static/search_api/fhl_api.js"></script>


  <link href="static/search_api/search.css" rel="stylesheet" />
  <script src="static/search_api/qsbphp.create_color_span_from_bible_text.js"></script>
  <script src="static/search_api/sephp.se_record_2_qsb_str.js"></script>
  <script src="static/search_api/qsbphp.search_reference.js"></script>
  <script src="static/search_api/sephp.pre_search_sn.js"></script>
  <script src="static/search_api/sephp.pre_search_keyword.js"></script>
  <script src="static/search_api/sephp.create_dialog_presearch.js"></script>
  <script src="static/search_api/sephp.create_dialog_search_result.js"></script>
  <script src="static/search_api/sephp.search.js"></script>
  <!-- 串珠要用的 2015.11.19(五) -->
  <script src="static/qsb_api/qsb.qsbapi.js"></script>
  <script src="static/tsk_api/tsk.tskapi.js"></script>
  <script src="static/tsk_api/tsk.R.frame.oneref.js"></script>

  <!-- 講道要用的 2016.01.13  -->
  <script src="static/preach_api/preach_api.js"></script>

  <!--有聲聖經-->
  <script src="static/bible_audio_api/audiobible_api.js"></script>
  <!-- 版權宣告要用的 2016.01.21(四) -->
  <script src="static/copyright_api/copyright_api.js"></script>
  <!--[if IE]>
  <link rel="stylesheet" href="./static/libs/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->

  <script src="static/fhlmap_api/fhlmap.js"></script>
  <script src="static/fhlmap_api/fhlmap_main.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?signed_in=true&libraries=geometry&sensor=false"></script>


  <script>
            var fhlUrlParameter = new FHL.FhlUrlParameter()

            var pageState;
            var currentSWVer = "1.2";
            var isfirstob; // ob 典藏用

            function setPageState(ps) {

              $(document).trigger('go', {
                chineses: ps.chineses,
                chap: ps.chap,
                sec: ps.sec
              });
              // 這個 go, 會使變數存起來, 下起開啟網頁還是會保留原本的 history
            }
            function pageStateInit() {
              pageState = {
                // 'Gen'
                engs: "Gen",
                // '創'
                chineses: "創",
                // 1
                chap: 1,
                // 1
                sec: 1,
                // bookIndex, book 這個先被用掉了.
                bookIndex: 1,
                // ['unv', 'svc']
                version: ["unv"],
                // 0
                strong: 0,
                // 0
                gb: 0,
                // book 別以為是 bookIndex, 因為 book 先被注釋用掉了 sc.php 參數
                book: 3, N: 0, k: "", cname: ["和合本"], realTimePopUp: 0, titleId: "fhlInfoComment",
                history: [{ chineses: "創", chap: 1 }], fontSize: 12, commentBackgroundChap: 1, commentBackgroundSec: 1,
                leftBtmWinShow: true, searchTitleMsg: "", audio: 0, swVer: currentSWVer,
                ispho: false, ispos: false
              };
            }

            function windowAdjust() {
              if (!document.mozFullScreen && !document.webkitIsFullScreen) {
                $("#mainWindow").css({ top: "40px" });
                //$("#bookSelectPopUp").css({top: "100px"});
              }

              /* for leftWindow height */
              var height = $(window).height() - $('#fhlTopMenu').height() - 12;
              if (document.mozFullScreen || document.webkitIsFullScreen)
                height += $('#fhlTopMenu').height();
              $('#fhlLeftWindow').css({ height: height + 'px' });

              $('#viewHistory').css({ top: $('#fhlLeftWindow').height() - $('#viewHistory').height() - 12 + 'px' });
              $('#versionSelect').css({ height: $('#fhlLeftWindow').height() - $('#settings').height() - $('#viewHistory').height() - 36 + 'px' });

              /* for MidWindow and fhlInfo height */

              //var mainWindow = document.querySelector("#mainWindow");
              height = $(window).height() - $('#fhlTopMenu').height() - $('#fhlToolBar').height() - 36 - 1;
              if (document.mozFullScreen || document.webkitIsFullScreen)
                height += $('#fhlTopMenu').height();

              $('#fhlMidWindow').css({
                height: height + 'px'
              });

              $('#fhlInfo').css({
                height: height + 'px'
              });

              /* for MidBottomWindow height */

              if ($("#fhlMidBottomWindowControl").hasClass('selected'))
                height -= ($("#fhlMidBottomWindow").height() + 12);

              $('#fhlLecture').css({
                height: height + 'px'
              });

              $('#fhlMidBottomWindow').css({ 'top': height + 12 + 'px' });

              /* for fhlMidWinow width */

              var width = $(window).width() - 24;

              if ($("#fhlLeftWindowControl").hasClass('selected'))
                width -= ($("#fhlLeftWindow").width() + 12);

              if ($('#fhlInfoWindowControl').hasClass('selected'))
                width -= ($("#fhlInfo").width() + 12);

              $("#fhlMidWindow").css({
                'width': width + 'px'
              });


              /* for fhlInfo width */

              var fhlInfoLeft = 10;
              if ($('#fhlInfoWindowControl').hasClass('selected')) {
                $('#fhlInfo').css({
                  'left': $(window).width() - $('#fhlInfo').width() - 12 + 'px'
                });
              }
              else {
                $('#fhlInfo').css({
                  'left': $(window).width() + 15 + 'px'
                });
              }

              /*  */
              $('#lecMain').scrollTop($('#lecMain').scrollTop() + $('#lecMain').find('.lec.selected').position().top - 80);
            }

            $(window).resize(function (e) {
              if (e.target == window) {
                windowAdjust();

                fhlLecture.reshape(pageState);//ps的全域即是 pageState, 只是這裡沒有傳過來, 只好偷存取全域的 snow-add
              }

            });

            $(function () {
              //fhlTopMenu.init(pageState);
              //fhlTopMenu.render(pageState);
              //Check cache
              if (localStorage.getItem("fhlPageState") != null) {
                //console.log(localStorage.getItem("fhlPageState"));
                var tmp = JSON.parse(localStorage.getItem("fhlPageState"));
                if (tmp.swVer != currentSWVer) {
                  // pageState 版本變更
                  pageStateInit();
                  setPageState(pageState);
                } else {
                  // 從 localStorage 載入
                  pageState = tmp;
                  setPageState(pageState);
                }
              } else {
                pageStateInit();
                // 2017.07 若人家是直接貼上url含有 書卷章節, 就從裡面取代
                setPageState(pageState);
              }

              $('#problemsReport').attr("href", "mailto:sean@fhl.net,tjm@fhl.net,snowray712000@gmail.com?subject=[問題回報] 信望愛聖經工具NUI");
              fhlToolBar.init(pageState);
              fhlLeftWindow.init(pageState);
              fhlMidWindow.init(pageState);
              fhlInfo.init(pageState);
              registerEvents(pageState);


            });
            //var urlJSON = "http://bkbible.fhl.net/json/"; // 小雪本機開發要用這個. 上線後要用下面那個 2015.10.24(六)
            var urlJSON = "https://bkbible.fhl.net/json/";

            // 2017.07 下面整理與NUI2一致.

            var chineseNumber = FHL.CONSTANT.Bible.CHINESE_NUMBERS;
            var book = FHL.CONSTANT.Bible.CHINESE_BOOK_ABBREVIATIONS;
            var bookGB = FHL.CONSTANT.Bible.CHINESE_BOOK_ABBREVIATIONS_GB;
            var bookFullName = FHL.CONSTANT.Bible.CHINESE_BOOK_NAMES;
            var bookFullName2 = FHL.CONSTANT.Bible.CHINESE_BOOK_NAMES_GB;
            var bookChapters = FHL.CONSTANT.Bible.BOOK_CHAPTERS;
            var bookEng = FHL.CONSTANT.Bible.ENGLISH_BOOK_ABBREVIATIONS;

            function getAjaxUrl(func, ps, idx) {
              var paramArr = new Array("engs", "chineses", "chap", "sec", "version",
                "strong", "gb", "book", "N", "k");
              var urlParams = {
                sc: [0, 2, 3, 6, 7],
                qb: [1, 2, 4, 5, 6],
                qp: [0, 2, 3, 6],
                sd: [6, 8, 9]
              };
              var getFullAjaxUrl = function (func, ps, idx) {
                var ret = urlJSON + func + ".php?";
                for (var i = 0; i < urlParams[func].length; i++) {
                  var paramKey = paramArr[urlParams[func][i]];

                  if (paramKey == "version") {
                    ret += paramKey;
                    ret += "=";
                    ret += encodeURIComponent(ps[paramKey][idx]);
                    ret += "&";
                  } else {
                    ret += paramKey;
                    ret += "=";
                    ret += encodeURIComponent(ps[paramKey]);
                    ret += "&";
                  }
                };

                ret = ret.substring(0, ret.length - 1);
                //console.log(ret); //https://bkbible.fhl.net/json/qp.php?engs=Rom&chap=16&sec=27&gb=0
                return ret;
              }
              return getFullAjaxUrl(func, ps, idx);
            }

            function getBookFunc(func, bookName) {
              var i;
              // 2016.11, 簡體中文, 會取出 null, 修正完畢
              for (i = 0; i < book.length; i++) {
                if (FHL.CONSTANT.Bible.CHINESE_BOOK_ABBREVIATIONS[i] == bookName) break;
                if (FHL.CONSTANT.Bible.CHINESE_BOOK_ABBREVIATIONS_GB[i] == bookName) break;
              }

              var ret;
              switch (func) {
                case "index":
                  ret = i;
                  break;
                case "indexByEngs":
                  for (i = 0; i < bookEng.length; i++)
                    if (bookEng[i] == bookName) break;
                  ret = i;
                  break;
                case "bookFullName":
                  ret = (pageState.gb == 1) ? bookFullName2[i] : bookFullName[i];
                  break;
                case "bookChapters":
                  ret = bookChapters[i];
                  break;
                case "bookEng":
                  ret = bookEng[i];
                  break;
                default:
                  ret = "failed";
                  break;
              }
              return ret;
            }

            function requestFullscreen() {
              $("#mainWindow").css({ top: "0px" });
              //$("#bookSelectPopUp").css({top: "0px"});
              var mainWindow = document.querySelector("#mainWindow");
              if ((document.fullScreenElement !== undefined && document.fullScreenElement === null) || (document.msFullscreenElement !== undefined && document.msFullscreenElement === null) || (document.mozFullScreen !== undefined && !document.mozFullScreen) || (document.webkitIsFullScreen !== undefined && !document.webkitIsFullScreen)) {
                if (mainWindow.requestFullScreen) {
                  mainWindow.requestFullScreen();
                } else if (mainWindow.mozRequestFullScreen) {
                  mainWindow.mozRequestFullScreen();
                } else if (mainWindow.webkitRequestFullScreen) {
                  mainWindow.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (mainWindow.msRequestFullscreen) {
                  mainWindow.msRequestFullscreen();
                }
              }
            }

            function registerEvents(ps) {
              /* scrolling register */
              /*setTimeout(function() {
                  $('div').scroll(function() {
                      $(this).addClass('scrolling');
                      clearTimeout( $.data( this, "scrollCheck" ) );
                      $.data( this, "scrollCheck", setTimeout(function() {
                          $('div').removeClass('scrolling');
                      }, 350) );
                  });
              }, 2000);*///等到其他function 跑完 (backup 用)

              /*shortcut register*/
              $(document).bind('keydown', 'alt+shift+f', function () {
                $('[data-ic-class="search-trigger"]').trigger("click");
                setTimeout(function () { $('[data-ic-class="search-clear"]').trigger("click"); }, 1);
              });
              $(document).bind('keydown', 'esc', function () {
                $('#helpingPopUp').css({
                  'visibility': 'hidden',
                  'opacity': '0'
                });
              });
              $(document).keyup(function (e) {
                if (e.keyCode == 27) { // escape key maps to keycode `27`
                  // exit from fullscreen
                  windowAdjust();
                  $('#fullscreenControl').removeClass('selected');
                }
              });
              $(document).bind('keydown', 'alt+shift+l', function () {
                //document.documentElement.webkitRequestFullScreen();
                requestFullscreen();
                $('#fullscreenControl').addClass('selected');
              });
              $(document).bind('keydown', 'alt+shift+s', function () {
                var idx = getBookFunc("index", ps.chineses);
                var position = $('#bookSelect').position();
                position.left = '40%';//$('#bookSelect').position().left;
                position.top = '20%';//$('#bookSelect').position().top+$('#bookSelect').height()+10;
                bookSelectChapter.init(ps, $('#bookSelectChapter'), idx, position);
                bookSelectChapter.registerEvents(ps);
                //isBookSelectChapterPopUp=true;
                //bookselectchapter.dom.hide();
                bookSelectChapter.dom.show();
                //alert(pageState.chineses);
              });
              $(document).bind('keydown', 'alt+shift+z', function () {
                $('#fhlLeftWindowControl').trigger("click");
              });
              $(document).bind('keydown', 'alt+shift+x', function () {
                $('#fhlMidBottomWindowControl').trigger("click");
              });
              $(document).bind('keydown', 'alt+shift+c', function () {
                $('#fhlInfoWindowControl').trigger("click");
              });
              $(document).bind('keydown', 'alt+shift+/', function () {
                $('#help').trigger("click");
              });
              $(document).bind('keydown', 'ctrl+c', function () {
                var copyTextarea = document.querySelector('#test');
                //copyTextarea.style.backgroundColor = "red";
                copyTextarea.select();
              });

              /*in search input*/
              $('[data-ic-class="search-input"]').bind('keydown', 'alt+shift+f', function () {
                $('[data-ic-class="search-trigger"]').trigger("click");
                setTimeout(function () { $('[data-ic-class="search-clear"]').trigger("click") }, 1);
              });
              $('[data-ic-class="search-input"]').bind('keydown', 'esc', function () {
                $('[data-ic-class="search-input"]').val('');
                $('[data-ic-class="search-trigger"]').removeClass('active');
              });
              $('[data-ic-class="search-input"]').bind('keydown', 'return', function () {
                $('.searchBtn').trigger("click");
              });
            }

            /***** Start of fhlToolBar *****/

            var fhlToolBar = {
              init: function (ps) {
                //this.registerEvents();
                help.init(ps, $('#help'));
                windowControl.init(ps, $('#windowControl'));
                windowControl.registerEvents(ps);
                bookSelect.init(ps, $('#bookSelect'));
                searchTool.init(ps, $('#searchTool'));
                searchTool.registerEvents(ps);
              }
            };
            var help = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
                helpingPopUp.init(ps, $('#helpingPopUp'));
              },
              registerEvents: function (ps) {
                this.dom.on('click', function () {
                  $('#helpingPopUp').css({
                    'visibility': 'visible',
                    'opacity': '1'
                  });
                });
              },
              render: function (ps, dom) {
                var html = "";
                html += '?';
                dom.html(html);
                this.registerEvents(ps);
              }
            };

            var helpingPopUp = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                $('#helpCloseButton').click(function () {
                  $('#helpingPopUp').css({
                    'visibility': 'hidden',
                    'opacity': '0'
                  });
                });
              },
              render: function (ps, dom) {
                var html = "";
                html += '<div><div id="helpCloseButton"><i class="fa fa-times"></i></div><ul>\
                            <li>Alt + Shift + F: 搜尋</li>\
                            <li>Alt + Shift + S: 快速選章</li>\
                            <li>Alt + Shift + L: 全螢幕</li>\
                            <li>Alt + Shift + Z: 設定視窗開關</li>\
                            <li>Alt + Shift + X: 搜尋視窗開關</li>\
                            <li>Alt + Shift + C: 輔助視窗開關</li>\
                            <li>Alt + Shift + /: 幫助</li>\
                            <li>Esc: 跳出</li></ul></div>';
                $('#helpingPopUpInside').html(html);
                this.registerEvents(ps);
              }
            }

            var windowControl = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
                this.registerEvents(ps);
              },
              registerEvents: function (ps) {
                $('#windowControlIcon').click(function (e) {
                  if ($(this).hasClass('selected')) {
                    var that = $(this);
                    that.animate({ left: '0px' });
                    $("#windowControl").animate({ width: '30px' }, function () {
                      that.removeClass('selected');
                    });
                    $("#windowControlButtons").animate({ opacity: 0 }, 100);
                  }
                  else {
                    var that = $(this);
                    that.animate({ left: '20px' });
                    $("#windowControl").animate({ width: '350px' }, function () {
                      that.addClass('selected');
                    });
                    $("#windowControlButtons").animate({ opacity: 1 }, 800);
                  }
                  e.stopPropagation();
                });
                $(document).click(function () {
                  if ($('#windowControlIcon').hasClass('selected')) {
                    //$('#windowControlIcon').trigger( "click" );
                  }
                });
                $('#fhlLeftWindowControl').click(function () {
                  if ($(this).hasClass('selected')) {
                    var that = $(this);
                    var fhlLeftWindowWidth = $("#fhlLeftWindow").width();
                    $("#fhlLeftWindow").animate({ left: -fhlLeftWindowWidth - 15 + 'px' });
                    $("#fhlToolBar").animate({ left: '12px' });
                    $("#fhlMidWindow").animate({ left: '12px', width: $("#fhlMidWindow").width() + fhlLeftWindowWidth + 12 + 'px' }, function () {
                      that.removeClass('selected');

                      fhlLecture.reshape(ps);
                    });
                  }
                  else {
                    var that = $(this);
                    var fhlLeftWindowWidth = $("#fhlLeftWindow").width();
                    $("#fhlLeftWindow").animate({ left: '12px' });
                    $("#fhlToolBar").animate({ left: fhlLeftWindowWidth + 24 + 'px' });
                    $("#fhlMidWindow").animate({ left: fhlLeftWindowWidth + 12 + 12 + 'px', width: $("#fhlMidWindow").width() - fhlLeftWindowWidth - 12 + 'px' }, function () {
                      that.addClass('selected');

                      fhlLecture.reshape(ps);
                    });
                  }

                });
                $('#fhlMidBottomWindowControl').click(function () {
                  if ($(this).hasClass('selected')) {
                    var that = $(this);
                    var fhlMidBottomWindowHeight = $("#fhlMidBottomWindow").height();
                    $("#fhlMidBottomWindow").animate({ top: $('#fhlMidWindow').height() + 15 + 'px', bottom: -fhlMidBottomWindowHeight - 15 + 'px' });
                    $("#fhlLecture").animate({ bottom: '0px', height: $("#fhlLecture").height() + fhlMidBottomWindowHeight + 12 + 'px' }, function () {
                      that.removeClass('selected');
                    });
                  }
                  else {
                    var that = $(this);
                    var fhlMidBottomWindowHeight = $("#fhlMidBottomWindow").height();
                    $("#fhlMidBottomWindow").animate({ top: $('#fhlMidWindow').height() - fhlMidBottomWindowHeight + 'px', bottom: '0px' });
                    $("#fhlLecture").animate({ bottom: fhlMidBottomWindowHeight + 'px', height: $("#fhlLecture").height() - fhlMidBottomWindowHeight - 12 + 'px' }, function () {
                      that.addClass('selected');
                    });
                  }
                });
                $('#fhlInfoWindowControl').click(function () {
                  if ($(this).hasClass('selected')) {
                    var that = $(this);
                    var fhlInfoWidth = $("#fhlInfo").width();
                    $("#fhlInfo").animate({ left: $(window).width() + 15 + 'px', right: -fhlInfoWidth - 15 + 'px', width: fhlInfoWidth });
                    $("#fhlMidWindow").animate({ right: '12px', width: $("#fhlMidWindow").width() + fhlInfoWidth + 12 + 'px' }, function () {
                      that.removeClass('selected');

                      fhlLecture.reshape(ps);
                    });
                  }
                  else {
                    var that = $(this);
                    var fhlInfoWidth = $("#fhlInfo").width();
                    $("#fhlInfo").animate({ left: $(window).width() - fhlInfoWidth - 12 + 'px', right: '12px' });
                    $("#fhlMidWindow").animate({ right: fhlInfoWidth + 'px', width: $("#fhlMidWindow").width() - fhlInfoWidth - 12 + 'px' }, function () {
                      that.addClass('selected');

                      fhlLecture.reshape(ps);
                    });
                  }
                });
                $('#fullscreenControl').click(function () {
                  if ($(this).hasClass('selected')) {
                    var that = $(this);
                    setTimeout(function () { that.removeClass('selected'); }, 1);
                  }
                  else {
                    var that = $(this);
                    requestFullscreen();
                    setTimeout(function () { that.addClass('selected'); }, 1);
                  }
                });
                $('#windowControl').click(function (e) {
                  e.stopPropagation();
                });
              },
              render: function (ps, dom) {
                var html = "<i id='windowControlIcon' class='fa fa-tv fa-fw selected'></i><div id='windowControlButtons'><span id='fhlLeftWindowControl' class='selected' ><i class='fa fa-wrench fa-fw'></i></span><span id='fhlMidBottomWindowControl'><i class='fa fa-search-plus fa-fw'></i></span><span id='fhlInfoWindowControl' class='selected'><i class='fa fa-file-text-o fa-fw'></i></span><space style='margin: 0px 10px; cursor: default; color: #D0D0D0;'>|</space><span id='fullscreenControl'><i class='fa fa-arrows-alt fa-fw'></i></span></div>";
                dom.html(html);
              }
            };

            var bookSelect = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
                bookSelectPopUp.init(ps, $('#bookSelectPopUp'));
                bookSelectPopUp.registerEvents(ps);
              },
              registerEvents: function (ps) {
                var that = this;
                $('#bookSelect').unbind().click(function (e) {// 加上unbind() 讓創世記第二節之後的dropdown不會自動消失
                  if (bookSelectPopUp.dom.is(":visible")) {
                    bookSelectPopUp.dom.fadeOut('0.2');
                    setTimeout(function () {
                      bookSelect.dom.css({ 'color': '#D0D0D0' });
                    }, 200);
                  }
                  else {
                    bookSelectPopUp.dom.fadeIn('0.2');
                    bookSelect.dom.css({ 'color': '#00A0FF' });
                  }
                  e.stopPropagation();
                });
                $('#bookSelectPopUp').click(function () {
                  bookSelectPopUp.dom.fadeOut('0.2');
                  setTimeout(function () { bookSelect.dom.css({ 'color': '#D0D0D0' }); }, 200);
                });
                $(document).click(function () {
                  bookSelectPopUp.dom.fadeOut('0.2');
                  setTimeout(function () { bookSelect.dom.css({ 'color': '#D0D0D0' }); }, 200);
                });
                $('#bookSelectName').click(function (e) {
                  e.stopPropagation();
                });
                $('#bookSelect').mouseenter(function () {
                  if (!bookSelectPopUp.dom.is(":visible")) {
                    bookSelect.dom.css({ 'color': '#00A0FF' });
                  }
                });
                $('#bookSelect').mouseleave(function () {
                  if (!bookSelectPopUp.dom.is(":visible")) {
                    bookSelect.dom.css({ 'color': '#D0D0D0' });
                  }
                });
              },
              render: function (ps, dom) {
                var bookName = getBookFunc("bookFullName", ps.chineses);
                var html = "";
                if (bookName != "詩篇" && bookName != "诗篇")
                  html = bookName + "： 第" + chineseNumber[ps.chap] + "章";
                else
                  html = bookName + "： 第" + chineseNumber[ps.chap] + "篇";
                html += '&nbsp;&#9660;';
                dom.html(html);
                this.registerEvents(ps);
              }
            };

            var bookSelectPopUp = {
              init: function (ps, dom) {
                this.dom = dom;
                bookSelectName.init(ps, $('#bookSelectName'));
                bookSelectName.registerEvents(ps);
                this.dom.hide();
              },
              registerEvents: function (ps) {
                var that = this;
                this.dom.click(function (e) {
                  e.stopPropagation();
                });
              }
            };

            var bookSelectName = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                var that = this.dom;
                var isBookSelectChapterPopUp = false;

                this.dom.find('li li').click(function () {
                  var that = $(this);
                  var selectedColumnIndex = $(this).parents('li').index();
                  //var previousColumnIndex = bookSelectName.dom.find('#old-testament>ul>li.selected').index();
                  //var previousRowIndex = bookSelectName.dom.find('li li.selected').index();
                  //console.log(previousColumnIndex);
                  bookSelectName.dom.find('#old-testament>ul>li').removeClass('selected');

                  if (bookSelectName.dom.find('li li.selected').attr('chineses') == $(this).attr('chineses'))
                    $('.testaments>ul>li').animate({ left: '0px' }, { queue: false, duration: 300 });
                  else
                    $(this).parents('li').addClass('selected');
                  setTimeout(function () {
                    if (isBookSelectChapterPopUp === true && that.hasClass('selected')) {
                      isBookSelectChapterPopUp = true;
                      bookSelectName.dom.find('li li').removeClass('selected');
                      bookSelectChapter.dom.hide();
                    }
                    else {
                      $('#old-testament>ul>li:lt(' + selectedColumnIndex + ')').animate({ left: '-75px' }, { queue: false, duration: 200 });
                      $('#old-testament>ul>li:eq(' + selectedColumnIndex + ')').animate({ left: '-75px' }, { queue: false, duration: 200 });
                      $('#old-testament>ul>li:gt(' + selectedColumnIndex + ')').animate({ left: '75px' }, { queue: false, duration: 200 });
                      var idx = getBookFunc("index", that.attr('chineses'));
                      var isIE11 = !!navigator.userAgent.match(/Trident.*rv\:11\./);

                      if (/msie/.test(navigator.userAgent.toLowerCase())) //replace 2016.11, 參照: http://www.fwolf.com/blog/post/35
                      // if ($.browser.msie || isIE11) ( jQuery 1.90之後就不支援了)//mark 2016.11
                      {
                        var position = that.offset();
                        position.left = $('#old-testament').offset().left + 128 * (selectedColumnIndex) + 50;
                        position.top = $('#old-testament').offset().top + 30;
                        bookSelectChapter.init(ps, $('#bookSelectChapter'), idx, position);
                      }
                      else {
                        var position = that.offset();
                        position.left = $('#old-testament').position().left + that.position().left + 128 * (selectedColumnIndex) + 40;
                        position.top = $('#old-testament').position().top + 25;
                        bookSelectChapter.init(ps, $('#bookSelectChapter'), idx, position);
                      }
                      bookSelectChapter.registerEvents(ps);
                      bookSelectName.dom.find('li li').removeClass('selected');
                      that.addClass('selected');
                      isBookSelectChapterPopUp = true;
                      bookSelectChapter.dom.show();
                    }
                  }, 1);
                });
              },
              render: function (ps, dom) {
                var html = "<div id='bookSelectTitle'>經卷選擇</div><div id='bookSelectChapter'></div>";
                html += "<div id='old-testament' class='testaments'><ul><li></li><li><span class='bookClass'>摩西五經</span><ul>";
                for (var i = 0; i < 5; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul><span class='bookClass'>舊約歷史書</span><ul>";
                for (var i = 5; i < 17; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul></li><li><span class='bookClass'>詩歌智慧書</span><ul>";
                for (var i = 17; i < 22; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul><span class='bookClass'>大先知書</span><ul>";
                for (var i = 22; i < 27; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul></li><li><span class='bookClass'>小先知書</span><ul>";
                for (var i = 27; i < 39; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul></li><li><span class='bookClass'>福音書</span><ul>";
                for (var i = 39; i < 43; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul><span class='bookClass'>新約歷史書</span><ul>";
                for (var i = 43; i < 44; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul></li><li><span class='bookClass'>保羅書信</span><ul>";
                for (var i = 44; i < 57; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul></li><li><span class='bookClass'>其他書信</span><ul>";
                for (var i = 57; i < 65; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul><span class='bookClass'>預言書</span><ul>";
                for (var i = 65; i < 66; i++)
                  html += "<li><span>" + bookFullName[i] + "<i class='fa fa-angle-right fa-fw'></i></span></li>";
                html += "</ul></li><li></li></ul></div>";

                dom.html(html);

                for (var i = 0; i < bookFullName.length; i++) {
                  dom.find('li li:eq(' + i + ')').attr('chineses', book[i]);
                }
                /*for(var i=0;i<bookFullName.length;i++){
                  dom.find('li:eq('+i+')').attr('chineses',book[i]);
                }*/
              }
            };

            var bookSelectChapter = {
              init: function (ps, dom, idx, position) {
                this.dom = dom;
                this.idx = idx;
                this.dom.css({
                  'position': 'fixed',
                  'left': position.left,
                  'top': position.top,
                  'box-shadow': 'inset 0px 0px 5px 1px rgba(0,0,0,0.75)',
                });
                this.render(ps, this.dom, this.idx);
              },
              registerEvents: function (ps) {
                var that = this;
                this.dom.find('li').click(function () {
                  ps.chineses = book[that.idx];
                  ps.engs = bookEng[that.idx];
                  ps.chap = parseInt($(this).attr('chap'));
                  ps.sec = 1;
                  ps.bookIndex = that.idx + 1; // 0-based轉1-based (book已經被注釋用掉了)
                  setPageState(ps);
                  bookSelect.render(ps, bookSelect.dom);
                  fhlLecture.render(ps, fhlLecture.dom);
                  viewHistory.render(ps, viewHistory.dom);
                  fhlInfo.render(ps);
                  bookSelectPopUp.dom.hide();
                  //bookselectchapter.dom.hide();
                  bookSelect.dom.css({ 'color': '#FFFFFF' });

                  $(that).trigger('chapchanged');
                });
                $(document).click(function () {
                  //bookselectchapter.dom.hide('0.2');
                });
                this.dom.mouseenter(function () {
                  clearTimeout($.data($('#bookSelectChapter')[0], "bookSelectChapterAutoCloseTimeout"));
                });
              },
              render: function (ps, dom, idx) {
                var numOfChapters = bookChapters[idx];
                var html = "<div><ul>";
                for (var i = 1; i <= numOfChapters; i++) {
                  html += "<li>" + i + "</li>";
                }
                html += "</ul></div>";
                dom.html(html);
                for (var i = 0; i < numOfChapters; i++) {
                  dom.find('li:eq(' + i + ')').attr('chap', i + 1);
                }
              }
            };


            /***** End of fhlToolBar *****/

            /***** Start of fhlLeftWindow *****/

            var fhlLeftWindow = {
              init: function (ps) {
                settings.init(ps, $('#settings'));
                settings.registerEvents(ps);
                versionSelect.init(ps, $('#versionSelect'));
                //versionSelect.registerEvents(ps);
                viewHistory.init(ps, $('#viewHistory'));
                this.registerEvents();
              },
              registerEvents: function () {
                $('#fhlLeftWindow').resizable({
                  handles: 'e',
                  maxWidth: 300,
                  minWidth: 170,
                  resize: function (event, ui) {
                    var currentWidth = ui.size.width;
                    var fhlMidWindowWidth;
                    if ($('#fhlInfoWindowControl').hasClass('selected'))
                      fhlMidWindowWidth = $(window).width() - $("#fhlInfo").width() - currentWidth;
                    else
                      fhlMidWindowWidth = $(window).width() - currentWidth + 12;
                    $("#fhlMidWindow").css({
                      'width': fhlMidWindowWidth - 12 * 4 + 'px',
                      'left': currentWidth + 12 + 12 + 'px'
                    });
                    $('#fhlToolBar').css({
                      //'width': $(window).width()-$("#fhlLeftWindow").width()-36+'px',
                      'left': currentWidth + 12 + 12 + 'px',
                      'right': '12px'
                    });

                    // snow add 2016-07
                    fhlLecture.reshape(pageState);
                  }
                });
                $('.ui-resizable-handle.ui-resizable-e').html('<span>&#9776;</span>');
              }
            };

            var settings = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
                snSelect.init(ps, $('#snSelect'));
                snSelect.registerEvents(ps);
                realTimePopUpSelect.init(ps, $('#realTimePopUpSelect'));
                realTimePopUpSelect.registerEvents(ps);
                gbSelect.init(ps, $('#gbSelect'));
                gbSelect.registerEvents(ps);
                show_mode.init(ps, $('#show_mode'));
                show_mode.registerEvents(ps);
                mapTool.init(ps, $('#mapTool'));
                mapTool.registerEvents(ps);
                imageTool.init(ps, $('#imageTool'));
                imageTool.registerEvents(ps);
                fontSizeTool.init(ps, $('#fontSizeTool'));
                fontSizeTool.registerEvents(ps);
              },
              registerEvents: function (ps) {
                $('#settings p')
                  .on('click', function () {
                    var html = $(this).html() == "▼&nbsp;設定" ? "&#9654;&nbsp;設定" : "&#9660;&nbsp;設定";
                    $(this).html(html);
                    if ($(this).html() == "▼&nbsp;設定") {
                      var settingsHeight = Math.min(260, $('#fhlLeftWindow').height() - 38 - $('#viewHistory').height() - 36);
                      $("#settings").animate({ height: settingsHeight + 'px' }, { queue: false, duration: 500 });
                      var versionSelectHeight = settingsHeight < 260 ? 38 : $("#versionSelect").height() - settingsHeight + 38;//bug: 前面會變37不會變38不知道為什麼，所以用這行修正
                      $("#versionSelect").animate({ top: settingsHeight + 12 + 'px', height: versionSelectHeight + 'px' }, { queue: false, duration: 500 });
                      var html = versionSelectHeight == 38 ? "&#9654;&nbsp;聖經版本選擇" : "&#9660;&nbsp;聖經版本選擇";
                      $('#versionSelect p').html(html);
                    }
                    else {
                      var versionSelectHeight = $("#versionSelect").height() + $("#settings").height() - 38;
                      $("#versionSelect").animate({ top: 38 + 12 + 'px', height: versionSelectHeight + 'px' }, { queue: false, duration: 500 });
                      $("#settings").animate({ height: '38px' }, { queue: false, duration: 500 });
                      $("#versionSelect p").html("&#9660;&nbsp;聖經版本選擇");
                    }
                  });
                $('#settings').resizable({
                  handles: 's',
                  maxHeight: 280,
                  minHeight: 38,
                  resize: function (event, ui) {
                    var maxHeight = $('#fhlLeftWindow').height() - 38 - $('#viewHistory').height() - 36;
                    if (ui.size.height > maxHeight) {//不可以超過其他的bar
                      ui.size.height = maxHeight;
                      $("#versionSelect p").html("&#9654;&nbsp;聖經版本選擇");
                    }
                    var height = $('#fhlLeftWindow').height() - $('#viewHistory').height() - ui.size.height;
                    $("#versionSelect").css({
                      'top': ui.size.height + 12 + 'px',
                      'height': height - 36 + 'px'
                    });
                    $(this).css({
                      width: 'auto',
                      right: '0px'
                    });
                    var html = $(this).css('height') == '38px' ? "&#9654;&nbsp;設定" : "&#9660;&nbsp;設定";
                    $('#settings p').html(html);
                    var html = $('#versionSelect').css('height') == '38px' ? "&#9654;&nbsp;聖經版本選擇" : "&#9660;&nbsp;聖經版本選擇";
                    $('#versionSelect p').html(html);
                  }
                });
                $('.ui-resizable-handle.ui-resizable-s').html('<span>&#9776;</span>');
                $('#settingsScrollDiv').scroll(function () {
                  $(this).addClass('scrolling');
                  clearTimeout($.data(this, "scrollCheck"));
                  $.data(this, "scrollCheck", setTimeout(function () {
                    $('#settingsScrollDiv').removeClass('scrolling');
                  }, 350));
                });
              },
              render: function (ps, dom) {
                //dom.html("設定");
              }
            };

            var snSelect = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                $('#snOnOffSwitch').change(
                  function () {
                    if ($(this).is(':checked')) {
                      ps.strong = 1;
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    else {
                      ps.strong = 0;
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    setPageState(ps);
                  });
              },
              render: function (ps, dom) {
                var html = "<div>原文編號:</div>";
                html += '<div class="onOffSwitch">\
                                <input type="checkbox" name="snOnOffSwitch" class="onOffSwitch-checkbox" id="snOnOffSwitch">\
                                <label class="onOffSwitch-label" for="snOnOffSwitch">\
                                    <span class="onOffSwitch-inner"></span>\
                                    <span class="onOffSwitch-switch"></span>\
                                </label>\
                            </div>';
                dom.html(html);
                $('#snOnOffSwitch').attr("checked", (ps.strong == 1) ? true : false);
              }
            };
            var gbSelect = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                $('#gbSelectSwitch').change(
                  function () {
                    if ($(this).is(':checked')) {
                      ps.gb = 1;
                      //ps.chineses = bookGB[book.indexOf(ps.chineses)];
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    else {
                      ps.gb = 0;
                      //ps.chineses = book[bookGB.indexOf(ps.chineses)];
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    setPageState(ps);
                  });
              },
              render: function (ps, dom) {
                var html = "<div>繁簡切換:</div>";
                html += '<div class="onOffSwitch">\
                                <input type="checkbox" name="gbSelectSwitch" class="onOffSwitch-checkbox" id="gbSelectSwitch">\
                                <label class="onOffSwitch-label" for="gbSelectSwitch">\
                                    <span class="onOffSwitch-inner traditional-simpleSwitch"></span>\
                                    <span class="onOffSwitch-switch"></span>\
                                </label>\
                            </div>';
                //html += '<span style="color: #770000;">施工中...</span>';
                dom.html(html);
                $('#gbSelectSwitch').attr("checked", (ps.gb == 1) ? true : false);
              }
            };
            var show_mode = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
                if (ps.show_mode == null)
                  ps.show_mode = 1;
              },
              registerEvents: function (ps) {
                $('#show_modeSwitch').change(
                  function () {
                    if ($(this).is(':checked')) {
                      // checked 是指開啟圓圈移到右邊. 那就應該是 出現「交錯」
                      ps.show_mode = 2;
                      //ps.chineses = bookGB[book.indexOf(ps.chineses)];
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    else {
                      // 出現「並列」
                      ps.show_mode = 1;
                      //ps.chineses = book[bookGB.indexOf(ps.chineses)];
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    setPageState(ps);
                  });
              },
              render: function (ps, dom) {
                var html = "<div>顯示切換:</div>";
                html += '<div class="onOffSwitch">\
                                <input type="checkbox" name="show_modeSwitch" class="onOffSwitch-checkbox" id="show_modeSwitch">\
                                <label class="onOffSwitch-label" for="show_modeSwitch">\
                                    <span class="onOffSwitch-inner showmodeSwitch"></span>\
                                    <span class="onOffSwitch-switch"></span>\
                                </label>\
                            </div>';
                //html += '<span style="color: #770000;">施工中...</span>';
                dom.html(html);
                $('#show_modeSwitch').attr("checked", (ps.show_mode == 2) ? true : false);
              }
            };
            var realTimePopUpSelect = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                $('#realTimeOnOffSwitch').change(
                  function () {
                    if ($(this).is(':checked')) {
                      ps.realTimePopUp = 1;
                      fhlLecture.render(ps, fhlLecture.dom);
                      fhlInfo.render(ps, fhlInfoContent.dom);
                    }
                    else {
                      ps.realTimePopUp = 0;
                      fhlLecture.render(ps, fhlLecture.dom);
                      fhlInfo.render(ps, fhlInfoContent.dom);
                    }
                    setPageState(ps);
                  });
              },
              render: function (ps, dom) {
                var html = "<div>即時顯示:</div>";
                html += '<div class="onOffSwitch">\
                                <input type="checkbox" name="realTimeOnOffSwitch" class="onOffSwitch-checkbox" id="realTimeOnOffSwitch">\
                                <label class="onOffSwitch-label" for="realTimeOnOffSwitch">\
                                    <span class="onOffSwitch-inner"></span>\
                                    <span class="onOffSwitch-switch"></span>\
                                </label>\
                            </div>';
                dom.html(html);
                $('#realTimeOnOffSwitch').attr("checked", (ps.realTimePopUp == 1) ? true : false);
              }
            };
            var mapTool = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                $('#mapToolOnOffSwitch').change(
                  function () {
                    if ($(this).is(':checked')) {
                      // checked 是指開啟圓圈移到右邊. 那就應該是 出現「ON」
                      ps.ispos = true;
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    else {
                      // 出現「Off」
                      ps.ispos = false;
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    setPageState(ps);
                  });
              },
              render: function (ps, dom) {
                var html = "<div>地圖顯示:</div>";
                html += '<div class="onOffSwitch">\
                                <input type="checkbox" name="mapToolOnOffSwitch" class="onOffSwitch-checkbox" id="mapToolOnOffSwitch">\
                                <label class="onOffSwitch-label" for="mapToolOnOffSwitch">\
                                    <span class="onOffSwitch-inner"></span>\
                                    <span class="onOffSwitch-switch"></span>\
                                </label>\
                            </div>';
                //html += '<span style="color: #770000;">施工中...</span>';
                dom.html(html);
                $('#mapToolOnOffSwitch').attr("checked", ps.ispos);
              }
            };
            var imageTool = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                $('#imageToolOnOffSwitch').change(
                  function () {
                    if ($(this).is(':checked')) {
                      // checked 是指開啟圓圈移到右邊. 那就應該是 出現「ON」
                      ps.ispho = true;
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    else {
                      // 出現「Off」
                      ps.ispho = false;
                      fhlLecture.render(ps, fhlLecture.dom);
                    }
                    setPageState(ps);
                  });
              },
              render: function (ps, dom) {
                var html = "<div>圖片顯示:</div>";
                html += '<div class="onOffSwitch">\
                                <input type="checkbox" name="imageToolOnOffSwitch" class="onOffSwitch-checkbox" id="imageToolOnOffSwitch">\
                                <label class="onOffSwitch-label" for="imageToolOnOffSwitch">\
                                    <span class="onOffSwitch-inner"></span>\
                                    <span class="onOffSwitch-switch"></span>\
                                </label>\
                            </div>';
                //html += '<span style="color: #770000;">施工中...</span>';
                dom.html(html);
                $('#imageToolOnOffSwitch').attr("checked", ps.ispho);
              }
            };
            var fontSizeTool = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {


                $('#fhlLectureFontSizeSliderBar').change(function () {
                  $("#fhlLectureFontSize").val($('#fhlLectureFontSizeSliderBar').val());
                  $('#fhlLecture .lec').css({
                    'font-size': $('#fhlLectureFontSize').val() + 'pt',
                    'line-height': parseInt($('#fhlLectureFontSize').val()) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  $('#fhlLecture .lecContent.bhs.hebrew').css({
                    'font-size': (parseInt($('#fhlLectureFontSize').val()) + 6) + 'pt',
                    'line-height': parseInt($('#fhlLectureFontSize').val()) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  ps.fontSize = parseInt($('#fhlLectureFontSize').val());
                  fhlLecture.reshape(ps);//show add, 經文排整齊
                });
                $('#fhlLectureFontSize').change(function () {
                  if ($('#fhlLectureFontSize').val() > 60)
                    $('#fhlLectureFontSize').val(60);
                  else if ($('#fhlLectureFontSize').val() < 6)
                    $('#fhlLectureFontSize').val(6);
                  $('#fhlLectureFontSizeSliderBar').val($('#fhlLectureFontSize').val());
                  $('#fhlLecture .lec').css({
                    'font-size': $('#fhlLectureFontSize').val() + 'pt',
                    'line-height': parseInt($('#fhlLectureFontSize').val()) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  $('#fhlLecture .lecContent.bhs.hebrew').css({
                    'font-size': (parseInt($('#fhlLectureFontSize').val()) + 6) + 'pt',
                    'line-height': (parseInt($('#fhlLectureFontSize').val()) + 6) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  ps.fontSize = parseInt($('#fhlLectureFontSize').val());
                  fhlLecture.reshape(ps);//show add, 經文排整齊
                });
                $('#fhlLectureFontSizeSmaller').click(function () {
                  $('#fhlLectureFontSize').val(parseInt($('#fhlLectureFontSize').val()) - 2);
                  if ($('#fhlLectureFontSize').val() <= 6)
                    $('#fhlLectureFontSize').val(6);
                  $("#fhlLectureFontSizeSliderBar").val($('#fhlLectureFontSize').val());
                  $('#fhlLecture .lec').css({
                    'font-size': $('#fhlLectureFontSize').val() + 'pt',
                    'line-height': parseInt($('#fhlLectureFontSize').val()) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  $('#fhlLecture .lecContent.bhs.hebrew').css({
                    'font-size': (parseInt($('#fhlLectureFontSize').val()) + 6) + 'pt',
                    'line-height': (parseInt($('#fhlLectureFontSize').val()) + 6) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  ps.fontSize = parseInt($('#fhlLectureFontSize').val());
                  fhlLecture.reshape(ps);//show add, 經文排整齊
                });
                $('#fhlLectureFontSizeLarger').click(function () {
                  $('#fhlLectureFontSize').val(parseInt($('#fhlLectureFontSize').val()) + 2);
                  if ($('#fhlLectureFontSize').val() >= 60)
                    $('#fhlLectureFontSize').val(60);
                  $("#fhlLectureFontSizeSliderBar").val($('#fhlLectureFontSize').val());
                  $('#fhlLecture .lec').css({
                    'font-size': $('#fhlLectureFontSize').val() + 'pt',
                    'line-height': parseInt($('#fhlLectureFontSize').val()) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  $('#fhlLecture .lecContent.bhs.hebrew').css({
                    'font-size': (parseInt($('#fhlLectureFontSize').val()) + 6) + 'pt',
                    'line-height': (parseInt($('#fhlLectureFontSize').val()) + 6) * 1.25 + 'pt',
                    'margin': parseInt($('#fhlLectureFontSize').val()) * 1.25 - 15 + 'px 0px'
                  });
                  ps.fontSize = parseInt($('#fhlLectureFontSize').val());
                  fhlLecture.reshape(ps);//show add, 經文排整齊
                });
              },
              render: function (ps, dom) {
                var html = "<div>字體大小:</div>";
                html += ' <div id="fhlLectureFontSizeSmaller">A<span>-</span></div>\
                            <div id="fhlLectureFontSizeLarger">A<span>+</span></div>\
                            <div style="display: block; margin-top: 5px; height: 30px;">\
                                <input id="fhlLectureFontSizeSliderBar" type="range" min="6" max="60" value="'+ ps.fontSize + '" step="1" style="width: 95px;"/>\
                                <input id="fhlLectureFontSize" type="text" value="'+ ps.fontSize + '" style="width:16px;"/>\
                            </div>\
                            ';
                dom.html(html);
              }
            };

            function getVersionIdx(book) {
              return $('#versionSelect').find("li[book=" + book + "]").index();
            }
            function insertVersion(ps, dom) {
              var book = dom.attr('book');
              var cname = dom.attr('cname');
              var versionIdx = getVersionIdx(book);
              var inserted = false;
              //console.log('book='+book+",cname="+cname+",idx="+versionIdx);
              for (var i = 0; i < ps.version.length; i++) {
                if (versionIdx < getVersionIdx(ps.version[i])) {
                  ps.version.splice(i, 0, book);
                  ps.cname.splice(i, 0, cname);
                  inserted = true;
                  break;
                }
              }
              if (inserted == false) {
                ps.version.push(book);
                ps.cname.push(cname);
              }
            }

            var versionSelect = {
              init: function (ps, dom) {
                this.dom = dom;
                var that = this;
                var ajaxUrl = urlJSON + "uiabv.php";
                $.ajax({
                  url: ajaxUrl
                }).done(function (d, s, j) {
                  if (j) {
                    //console.log(j.responseText);
                    var jsonObj = JSON.parse(j.responseText);
                    that.data = jsonObj;
                  }
                  that.render(ps, dom, that.data);
                });
                var versionSelectHeight = $('#fhlLeftWindow').height() - $('#settings').height() - $('#viewHistory').height() - 36;
                $('#versionSelect').css({ height: versionSelectHeight + 'px' });
              },
              registerEvents: function (ps) {
                $('#versionSelect p').on('click', function () {
                  var html = $(this).html() == "▼&nbsp;聖經版本選擇" ? "&#9654;&nbsp;聖經版本選擇" : "&#9660;&nbsp;聖經版本選擇";
                  $(this).html(html);
                  if ($(this).html() == "▼&nbsp;聖經版本選擇") {
                    var versionSelectHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 38 - 36;
                    var viewHistoryTop = $('#fhlLeftWindow').height() - 38 - 12;
                    $("#versionSelect").animate({ height: versionSelectHeight + 'px' }, { queue: false, duration: 500 });
                    $("#viewHistory").animate({ height: '38px', top: viewHistoryTop + 'px' }, { queue: false, duration: 500 });
                    $("#viewHistory p").html("&#9654;&nbsp;歷史紀錄");
                  }
                  else {
                    var viewHistoryHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 38 - 36;
                    var viewHistoryTop = $('#fhlLeftWindow').height() - viewHistoryHeight - 12;
                    $("#versionSelect").animate({ height: '38px' }, { queue: false, duration: 500 });
                    $("#viewHistory").animate({ height: viewHistoryHeight + 'px', top: viewHistoryTop + 'px' }, { queue: false, duration: 500 });
                    $("#viewHistory p").html("&#9660;&nbsp;歷史紀錄");
                  }
                });
                var that = this;
                this.dom.find('li').click(function (e) {
                  $(this).toggleClass('selected');
                  if ($(this).hasClass('selected')) {
                    insertVersion(ps, $(this));
                    /*
                    ps.version.push($(this).attr('book'));
                    ps.cname.push($(this).attr('cname'));
                    */
                    //$(this).html("&#x2713"+$(this).html());
                  } else {
                    var idx = ps.version.indexOf($(this).attr('book'));
                    ps.version.splice(idx, 1);
                    ps.cname.splice(idx, 1);
                    //$(this).html($(this).html().substr(1, $(this).html().length-1));
                  }
                  //Set Default version?
                  if (ps.version.length == 0) {
                    var o = that.dom.find('li:eq(0)');
                    $(o).addClass("selected");
                    ps.version.push(o.attr('book'));
                    ps.cname.push(o.attr('cname'));
                  }
                  setPageState(ps);
                  fhlLecture.render(ps, fhlLecture.dom);
                  e.stopPropagation();
                });
                $('#versionSelect').resizable({
                  handles: 's',
                  maxHeight: 1006,
                  minHeight: 38,
                  resize: function (event, ui) {
                    var maxHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 38 - 36;
                    if (ui.size.height > maxHeight) {//不可以超過其他的bar
                      ui.size.height = maxHeight;
                    }
                    var viewHistoryHeight = $('#fhlLeftWindow').height() - $('#settings').height() - ui.size.height - 36;
                    var top = $('#settings').height() + ui.size.height + 24;
                    var versionSelectHeight = ui.size.height;
                    $("#viewHistory").css({
                      'height': viewHistoryHeight + 'px',
                      'top': top + 'px'
                    });
                    $(this).css({
                      width: 'auto',
                      right: '0px',
                      height: versionSelectHeight + 'px'
                    });
                    var html = $(this).css('height') == '38px' ? "&#9654;&nbsp;聖經版本選擇" : "&#9660;&nbsp;聖經版本選擇";
                    $('#versionSelect p').html(html);
                    var html = $('#viewHistory').css('height') == '38px' ? "&#9654;&nbsp;歷史紀錄" : "&#9660;&nbsp;歷史紀錄";
                    $('#viewHistory p').html(html);
                  }
                });
                $('.ui-resizable-handle.ui-resizable-s').html('<span>&#9776;</span>');
                $('#versionSelectScrollDiv').scroll(function () {
                  $(this).addClass('scrolling');
                  clearTimeout($.data(this, "scrollCheck"));
                  $.data(this, "scrollCheck", setTimeout(function () {
                    $('#versionSelectScrollDiv').removeClass('scrolling');
                  }, 350));
                });
              },
              render: function (ps, dom, data) {

                var that = this;
                var html = "<div class='secondLevelInside'><p>&#9660;&nbsp;聖經版本選擇</p><div id='versionSelectScrollDiv'><ul>";
                for (var i = 0; i < data.record_count; i++) {
                  var o = data.record[i];
                  html += "<li>" + o.cname + "</li>";
                  /*if(o.cname)
                  console.log(o.cname);
                  else
                      console.log("nothing");*/
                  if (o.cname === "原文直譯(參考用)") //()括號在parse 時會出錯
                    o.cname = "原文直譯";
                }

                html += "</ul></div></div>";
                dom.html(html);
                for (var i = 0; i < data.record_count; i++) {
                  var o = data.record[i];
                  dom.find('li:eq(' + i + ')').attr(o);
                }
                dom.find('li').removeClass('selected');
                for (var i = 0; i < ps.version.length; i++) {
                  var v = ps.version[i];
                  var li = dom.find('li[book="' + v + '"]');
                  if (li != null) {
                    li.each(function () {
                      $(this).addClass('selected');
                      var html = "";/*&#x2713*/
                      html += $(this).html();
                      $(this).html(html);
                    });
                  }
                }
                that.registerEvents(ps);
              }
            };

            function setBook(ps, bookName) {
              var idx = null;
              if (book.indexOf(bookName) != -1) {
                idx = book.indexOf(bookName);
              }
              else if (bookGB.indexOf(bookName) != -1) {
                idx = bookGB.indexOf(bookName);
              }
              else if (bookEng.indexOf(bookName) != -1) {
                idx = book.indexOf(bookName);
              } else {
                idx = null;
              }
              if (idx != null) {
                ps.chineses = book[idx];
                ps.engs = bookEng[idx];
              } else {
                console.log('setBook error:idx is null');
              }
            }
            // 因為 document 的事件愈來愈多自訂的, 就不知道有哪些了,
            // 所以新增一個物件來管理 document 的事件
            var docEvent = (function () {
              var $doc = $(document);
              function DocEvent() { };
              var fn = DocEvent.prototype;

              fn.when_vh_init = function (fn) {
                /// <summary> view history init </summary>
                /// <param type="fn(e,p1)" name="fn" parameterArray="false">初始化完成時執行</param>
                $doc.on({
                  vh_init: fn
                });
              };
              fn.when_vh_idxchanged = function (fn) {
                /// <summary> view history idx changed </summary>
                /// <param type="fn(e,p1)" name="fn" parameterArray="false">_idx 改變時執行 </param>
                $doc.on({
                  vh_idxchanged: fn
                });
              };
              fn.when_vh_itemschanged = function (fn) {
                /// <summary> view history idx changed </summary>
                /// <param type="fn(e,p1)" name="fn" parameterArray="false"> 內容改變時執行 </param>
                $doc.on({
                  vh_itemschanged: fn
                });
              };

              fn.when_go = function (fn) {
                /// <summary> setPageState() 被呼叫時, 將會觸發 go </summary>
                /// <param type="fn(e,p1)" name="fn" parameterArray="false">p1:{chineses,chap,sec}</param>
                $doc.on({
                  go: fn
                });
              };

              return new DocEvent();
            })();
            $(document).ready(function () {
              (function () {
                var _datas = [];
                var _idx = -1;

                function trigger_init() {
                  $(document).trigger('vh_init', { datas: _datas, idx: _idx });
                  trigger_vh_idxchanged();
                  trigger_vh_itemschanged();
                }
                function trigger_vh_idxchanged() {
                  $(document).trigger('vh_idxchanged', { datas: _datas, idx: _idx });
                }
                function trigger_vh_itemschanged() {
                  $(document).trigger('vh_itemschanged', { datas: _datas, idx: _idx });
                }

                // callback
                // viewHistory主界面, 按下其中一個選項的時候, 觸發 idx changed
                viewHistory.when_liclick(function (e, p1) {
                  _idx = p1.idx;
                  trigger_vh_idxchanged();
                });
                // viewHistory主界面, 按下清除所有的時候, 觸發 items changed
                viewHistory.when_clearall(function (e) {
                  _datas = [_datas[0]];
                  _idx = 0;
                  trigger_vh_itemschanged();
                });
                // 當別的地方切換章節的時候, 要新增到 datas, 並觸發事件
                docEvent.when_go(function (e, p1) {
                  if (_idx == -1) {
                    _datas = pageState.history;
                    _idx = 0;
                    trigger_init();
                  }
                  // 若只是「切換節」而不是「書卷或是章」，就不處理
                  else if (_datas[_idx].chap != p1.chap || _datas[_idx].chineses != p1.chineses) {
                    // 清空 idx 前
                    var a1 = _datas.slice(_idx, _datas.length);
                    a1.unshift(p1);
                    _datas = a1;
                    _idx = 0;

                    trigger_vh_itemschanged();
                  }
                });
                // 當 history 改變的時候, 要儲存 ps (其實這個不知道放到哪個class較好, 就先放在這)
                docEvent.when_vh_itemschanged(function (e, p1) {
                  pageState.history = p1.datas;
                  setBook(pageState, pageState.chineses);
                  localStorage.setItem("fhlPageState", JSON.stringify(pageState));
                });
                // 當 fhlLecture 中的 back click 或 nextclick 被按的時候
                fhlLecture.when_bclick_or_nclick(function () {
                  if (_idx < _datas.length - 1) {
                    _idx++;
                    trigger_vh_idxchanged();

                    // 下面是原本的code 還沒完全被取代掉 (切換章節,卻不送出go event)
                    var ps = pageState;
                    setBook(ps, _datas[_idx].chineses);
                    ps.chap = _datas[_idx].chap;
                    ps.sec = 1;
                    //setPageState(ps); // 不要 trigger 出 'go'
                    bookSelect.render(ps, bookSelect.dom);
                    fhlInfo.render(ps, fhlInfo.dom);
                    fhlLecture.render(ps, fhlLecture.dom);
                  }
                }, function () {
                  if (_idx > 0) {
                    _idx--;
                    trigger_vh_idxchanged();

                    // 下面是原本的code 還沒完全被取代掉 (切換章節,卻不送出go event)
                    var ps = pageState;
                    setBook(ps, _datas[_idx].chineses);
                    ps.chap = _datas[_idx].chap;
                    ps.sec = 1;
                    //setPageState(ps); // 不要 trigger 出 'go'
                    bookSelect.render(ps, bookSelect.dom);
                    fhlInfo.render(ps, fhlInfo.dom);
                    fhlLecture.render(ps, fhlLecture.dom);
                  }
                });
                // 等待 ps.history ok 就觸發觸始化
                (function () {
                  function tryit() {
                    if (pageState == null || pageState.history == null || pageState.history.length == 0)
                      setTimeout(tryit, 777);//try it again
                    else
                      $(document).trigger('go', { chineses: pageState.chineses, chap: pageState.chap, sec: pageState.sec });
                  }
                  setTimeout(tryit, 777);
                })();

                // 模擬 1
                //_datas.push({ chineses: '創', chap: 1 });
                //_datas.push({ chineses: '出', chap: 1 });
                // _idx = 0;
                // trigger_init();

                // 模擬 2
                //setTimeout(function () {
                //  _idx = 1;
                //  trigger_vh_idxchanged();
                //}, 2000);

                // 模擬 3
                //setTimeout(function () {
                //  _datas.push({ chineses: '創', chap: 3 });
                //  _idx = 0;

              })();
            });

            var viewHistory = (function () {
              function ViewHistory() { };
              var fn = ViewHistory.prototype;

              fn.when_liclick = function (fn) {
                /// <summary> ul 清單中的 li 被 click 的時候</summary>
                /// <param type="fn(e,p1)" name="fn" parameterArray="false">{idx},回傳的是ul指在清單中的idx,</param>
                $(viewHistory.dom).on({
                  liclick: fn
                }, 'li');
              };
              fn.when_clearall = function (fn) {
                /// <summary> 清除所有 被按下去的時候 </summary>
                /// <param type="fn(e)" name="fn" parameterArray="false"></param>
                $(viewHistory.dom).on({
                  clearall: fn
                }, '.clearHistory');
              };
              fn.init = function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
                var viewHistoryTop = $('#fhlLeftWindow').height() - 38 - 12;
                $('#viewHistory').css({ top: viewHistoryTop });


                var $vh = $('#viewHistory');
                function renderList(datas) {
                  /// <summary> 用於畫 li 清單, ul先被清空, 再一一加入 </summary>
                  /// <param type="[{.chineses, .chap},{},{}]" name="datas" parameterArray="true">清單</param>
                  var ul = $vh.find('ul').first();
                  ul.empty();
                  Enumerable.From(datas).ForEach(function (a1) {
                    ul.append($("<li chineses=" + a1.chineses + " chap=" + a1.chap + ">" + a1.chineses + ":" + a1.chap + "</li>"));
                  })
                }
                $(document).on({
                  vh_init: function (e, p1) {
                    renderList(p1.datas);
                  },
                  vh_itemschanged: function (e, p1) {
                    renderList(p1.datas);
                  }
                });

                $vh.on({
                  click: function (e) {

                    // 傳出第幾個被點 ( 考慮 可5 可8 可5 ... 到底哪個可5被點 ) 0-based
                    var ul = $vh.find('ul').first();
                    var lis = ul.children();
                    for (var i = 0; i < lis.length; i++) {
                      if (lis[i] == this)
                        break;
                    }

                    $(this).trigger('liclick', {
                      idx: i,
                      chineses: $(this).attr('chineses'),
                      chap: parseInt($(this).attr('chap'))
                    });

                    // 下面是原本的code 還沒完全被取代掉
                    setBook(ps, $(this).attr('chineses'));
                    ps.chap = parseInt($(this).attr('chap'));
                    ps.sec = 1;
                    //setPageState(ps); // 不要 trigger 出 'go'
                    bookSelect.render(ps, bookSelect.dom);
                    fhlInfo.render(ps, fhlInfo.dom);
                    fhlLecture.render(ps, fhlLecture.dom);
                    // that.render(ps, that.dom); // 已經處理了. vh_itemchanged 會處理
                  }
                }, 'li').on({
                  click: function (e) {
                    $(this).trigger('clearall');
                  }
                }, '.clearHistory');
              }
              fn.registerEvents = function (ps) {
                var that = this;
                $('#viewHistory p')
                  .on('click', function () {
                    var html = $(this).html() == "▼&nbsp;歷史紀錄" ? "&#9654;&nbsp;歷史紀錄" : "&#9660;&nbsp;歷史紀錄";
                    $(this).html(html);
                    if ($(this).html() == "▼&nbsp;歷史紀錄") {
                      var viewHistoryHeight = Math.min(36 * ps.history.length + 64, $('#fhlLeftWindow').height() - $('#settings').height() - 38 - 36);
                      var viewHistoryTop = $('#fhlLeftWindow').height() - viewHistoryHeight - 12;
                      if (viewHistoryHeight == 36 * ps.history.length + 64) {
                        var versionSelectHeight = $("#versionSelect").height() + $("#viewHistory").height() - viewHistoryHeight;
                        $("#versionSelect").animate({ height: versionSelectHeight + 'px' }, { queue: false, duration: 500 });
                      }
                      else {
                        $("#versionSelect").animate({ height: '38px' }, { queue: false, duration: 500 });
                        $("#versionSelect p").html("&#9654;&nbsp;聖經版本選擇");
                      }
                      $("#viewHistory").animate({ height: viewHistoryHeight + 'px', top: viewHistoryTop + 'px' }, { queue: false, duration: 500 });
                      $("#viewHistory p").html("&#9660;&nbsp;歷史紀錄");
                    }
                    else {
                      var versionSelectHeight = $('#fhlLeftWindow').height() - $('#settings').height() - 38 - 36;
                      var viewHistoryTop = $('#fhlLeftWindow').height() - 38 - 12;
                      $("#versionSelect").animate({ height: versionSelectHeight + 'px' }, { queue: false, duration: 500 });
                      $("#versionSelect p").html("&#9660;&nbsp;聖經版本選擇");
                      $("#viewHistory").animate({ height: '38px', top: viewHistoryTop + 'px' }, { queue: false, duration: 500 });
                      $("#viewHistory p").html("&#9654;&nbsp;歷史紀錄");
                    }
                  });
                //$('.clearHistory').click(function () {
                //  ps.history = [{ chineses: ps.chineses, chap: ps.chap }];
                //  setPageState(ps);
                //  viewHistory.render(ps, viewHistory.dom);
                //});
                //this.dom.find('li')
                //.css({ cursor: "pointer" })
                //.click(function () {
                //  setBook(ps, $(this).attr('chineses'));
                //  ps.chap = parseInt($(this).attr('chap'));
                //  ps.sec = 1;
                //  setPageState(ps);
                //  bookSelect.render(ps, bookSelect.dom);
                //  fhlInfo.render(ps, fhlInfo.dom);
                //  fhlLecture.render(ps, fhlLecture.dom);
                //  that.render(ps, that.dom);
                //});
                $('#viewHistoryScrollDiv').scroll(function () {
                  $(this).addClass('scrolling');
                  clearTimeout($.data(this, "scrollCheck"));
                  $.data(this, "scrollCheck", setTimeout(function () {
                    $('#viewHistoryScrollDiv').removeClass('scrolling');
                  }, 350));
                });
              }
              fn.render = function (ps, dom) {
                /*
                    <div id="viewHistory">
                      <div class="secondLevelInside">
                        <p>&#9654;&nbsp;歷史記錄</p>
                        <span class="clearHistory">清除記錄</span>
                        <div id="viewHistoryScrollDiv">
                          <ul class="viewHistoryList"></ul>
                        </div>
                      </div>
                    </div>
                */
                var vh = $("#viewHistory");
                if (vh.height() == 38)
                  vh.find('p').first().html('&#9654;&nbsp;歷史記錄');
                else
                  vh.find('p').first().html('&#9660;&nbsp;歷史記錄');
                //var html="<div class='secondLevelInside'>";
                //if($("#viewHistory").height()==38)
                //  html+="<p>&#9654;&nbsp;歷史紀錄</p>";
                //else
                //  html+="<p>&#9660;&nbsp;歷史紀錄</p>";
                //html+="<span class='clearHistory'>清除記錄</span><div id='viewHistoryScrollDiv'><ul class='viewHistoryList'>";
                //for(var i=ps.history.length-1;i>=0;i--){
                //  var r=ps.history[i];
                //  html+="<li chineses="+r.chineses+" chap="+r.chap+">";
                //  html+=r.chineses+":"+r.chap+"</li>";
                //}
                //html+="</ul></div></div>";
                //dom.html(html);

                this.registerEvents(ps);
              }
              return new ViewHistory();
            })();

            /***** End of fhlLeftWindow *****/

            /***** Start of fhlMidWindow *****/
            var fhlMidWindow = {
              init: function (ps, dom) {
                this.dom = dom;
                fhlLecture.init(pageState, $('#fhlLecture'));
                fhlMidBottomWindow.init(pageState, $('#fhlMidBottomWindow'));
                this.render(ps, dom);
              },
              render: function (ps, dom) {
                var width = $(window).width() - $("#fhlLeftWindow").width() - $("#fhlInfo").width() - 12 * 4;
                $("#fhlMidWindow").css({
                  'width': width + 'px'
                });
              }
            }

            function setCSS(col, ps) {
              var totalWidth = 100;
              $('.lecContent').css('width', (totalWidth / col) + "%");
              $('.lecVersion').css('width', (totalWidth / col) + "%");
            }

            function setFont() {
              $('.bhs').addClass('hebrew');
              $('.nwh').addClass('greek');
              $('.lxx').addClass('greek');
            }

            function getBibleText(col, ps, cbk, defCbk) {
              var sem = col;
              //console.log("enter getBibleText");
              for (var i = 0; i < col; i++) {
                //console.log("launch ajax"+i);
                //added by sean 2015.10.20
                var temp_ps = ps;
                if (ps.gb == 1 && bookGB.indexOf(ps.chineses) == -1) {
                  temp_ps.chineses = bookGB[book.indexOf(ps.chineses)];
                }
                else if (ps.gb == 0 && book.indexOf(ps.chineses) == -1) {
                  temp_ps.chineses = book[bookGB.indexOf(ps.chineses)];
                }

                var ajaxUrl = getAjaxUrl("qb", temp_ps, i);
                $.ajax({
                  url: ajaxUrl
                }).done(function (d, s, j) {
                  if (j) {
                    //console.log(j.responseText);
                    var jsonObj = JSON.parse(j.responseText);
                    cbk(jsonObj);
                    sem--;
                  }
                });
              }//for each icol
              var def = setInterval(function () {
                if (sem == 0) {
                  defCbk();
                  clearInterval(def);
                }
              }, 100);
            }

            function checkOldNew(ps) {
              //0 - Old
              //1 - New
              return (book.indexOf(ps.chineses) >= 39) ? 0 : 1;
            }

            function parseBibleText(text, ps, isOld, bibleVersion) {
              var ret;
              checkOldNew(ps);
              switch (ps.strong) {
                case 0:
                  ret = text;
                  break;
                case 1:
                  //console.log(text);
                  if (bibleVersion == "和合本" || bibleVersion == "KJV") {

                    function snReplace(s) {
                      //console.log(s);
                      if (s.substr(0, 4) === '{<WT') {
                        s = s.replace(/{<WT[G,H]+/g, "<span class='sn' N=" + isOld + ">{(");
                        s = s.replace(/>}/g, ")}</span>");
                      }
                      else if (s.substr(0, 3) === '{<W') {
                        s = s.replace(/{<W[A,G,H]+/g, "<span class='sn' N=" + isOld + ">{&lt;");
                        s = s.replace(/>}/g, "&gt;}</span>");
                      }
                      else if (s.substr(0, 3) === '<WT') {
                        s = s.replace(/<WT[G,H]+/g, "<span class='sn' N=" + isOld + ">(");
                        s = s.replace(/>/g, ")</span>");
                      }
                      else if (s.substr(0, 2) === '<W') {
                        s = s.replace(/<W[A,G,H]+/g, "<span class='sn' N=" + isOld + ">&lt;");
                        s = s.replace(/>/g, "&gt;</span>");
                      }
                      else
                        console.debug('sn parsing error!');
                      return s;
                    }
                    text = text.replace(/[{]*<W[A,T,G,H]+[0-9]+a?>[}]*/g, snReplace);

                    //text=text.replace(/[{}]/g,"");
                    //text=text.replace(/>/g,"&gt;</span>");
                    //text=text.replace(/<W[a-zA-Z]*/g,"<span class='sn' N="+isOld+">&lt;");

                  }
                  //console.log(text);
                  ret = text;
                  break;
                default:
                  ret = text;
                  break;
              }
              if (bibleVersion == "舊約馬索拉原文" || bibleVersion == "新約WH原文") {
                ret = ret.replace(/</g, "&lt");
                ret = ret.replace(/>/g, "&gt");
                ret = ret.replace(/\r\n/g, "<br>");
              }
              return ret;
            }

            function getRecord(r, b, c, s) {
              var ret = null;
              for (var i = 0; i < r.length; i++) {
                if (r[i] == null)
                  break;
                if (r[i].chap == c && r[i].sec == s) {
                  ret = r[i];
                  break;
                }
              }
              return ret;
            }

            function sortBibleVersion(r, ps) {
              var tmpArr = new Array();
              for (var i = 0; i < ps.version.length; i++) {
                var version = ps.version[i];
                for (var j = 0; j < r.length; j++) {
                  if (version == r[j].version) {
                    tmpArr.push(r[j]);
                  }
                }
              }
              return tmpArr;
            }

            var fhlLecture = (function () {
              function FhlLecture() {
                this.that = this
              };

              var fn = FhlLecture.prototype;
              var $lecture;
              fn.init = function (ps, dom) {
                this.dom = dom;
                this.render(ps, dom);
                $lecture = $(this.dom);
                var $lecMain = $('#lecMain');
                var that = this
                // chapnext prev 變成1次事件就夠了
                $('.chapBack').click(function (e) {
                  var idx = getBookFunc("index", ps.chineses); // 0-based
                  if (ps.chap == 1) {
                    idx--;
                    ps.chineses = book[idx];
                    ps.engs = bookEng[idx];
                    ps.chap = bookChapters[idx];
                  } else {
                    if (ps.chap == 0) {
                      ps.chap = ps.commentBackgroundChap;
                      ps.sec = ps.commentBackgroundSec;
                    }
                    ps.chap--;
                  }
                  ps.bookIndex = idx + 1; // 此idx回傳是 0-based
                  ps.sec = 1;
                  setPageState(ps);
                  viewHistory.render(ps, viewHistory.dom);
                  fhlLecture.render(ps, fhlLecture.dom);
                  fhlInfo.render(ps);
                  bookSelect.render(ps, bookSelect.dom);
                  e.stopPropagation();

                  $(that).trigger('chapchanged');
                });
                $('.chapNext').click(function (e) {
                  var idx = getBookFunc("index", ps.chineses);
                  if (ps.chap == bookChapters[idx]) {//if last chapter
                    idx++;
                    ps.chineses = book[idx];//book+1
                    ps.engs = bookEng[idx];
                    ps.chap = 1;
                  } else {
                    if (ps.chap == 0) {
                      ps.chap = ps.commentBackgroundChap;
                      ps.sec = ps.commentBackgroundSec;
                    }
                    ps.chap++;
                  }
                  ps.bookIndex = idx + 1; // 此idx回傳是 0-based

                  ps.sec = 1;
                  setPageState(ps);
                  viewHistory.render(ps, viewHistory.dom);
                  fhlLecture.render(ps, fhlLecture.dom);
                  fhlInfo.render(ps);
                  bookSelect.render(ps, bookSelect.dom);
                  e.stopPropagation();

                  $(that).trigger('chapchanged');
                });
                $('#lecMain').scroll(function () {
                  $(this).addClass('scrolling');
                  clearTimeout($.data(this, "scrollCheck"));
                  $.data(this, "scrollCheck", setTimeout(function () {
                    $('#lecMain').removeClass('scrolling');
                  }, 350));
                });
                // title 中的 version name lecMainTitle 是固定的, 加在 這個事件一次即可
                $('#lecMainTitle').on({
                  click: function (e) {
                    var idx = ps.version.indexOf(versionSelect.dom.find('li[cname=' + $(this).children('.closeButton').attr('cname') + ']').attr('book'));
                    ps.version.splice(idx, 1);
                    ps.cname.splice(idx, 1);
                    versionSelect.dom.find('li[cname=' + $(this).children('.closeButton').attr('cname') + ']').removeClass('selected');
                    //Set Default version?
                    if (ps.version.length == 0) {
                      var o = versionSelect.dom.find('li:eq(0)');
                      ps.version.push(o.attr('book'));
                      ps.cname.push(o.attr('cname'));
                      versionSelect.dom.find('li:eq(0)').addClass('selected');
                    }
                    setPageState(ps);
                    fhlLecture.render(ps, fhlLecture.dom);
                    e.stopPropagation();
                  }
                }, '.versionName');
                // 內容中的 lecMain 是固定的, 加在這個事件一次即可
                $lecMain.on({
                  click: function (e) {
                    if ($(this).hasClass('copyright')) //版本宣告,應該不能click snow add 2016.01.22(五)
                      return;
                    var mode = $lecMain.attr('mode'); //0: 原本, 1:好選擇

                    var oldsec = ps.sec
                    var oldchap = ps.chap

                    ps.sec = parseInt($(this).attr('sec'));
                    ps.chap = parseInt($(this).attr('chap'));

                    if (mode == 0) {
                      $(that).find('.lec').removeClass('selected');
                      $(this).addClass('selected');
                    }
                    else if (mode == 1 || mode == 2) {
                      var vers = $lecMain.find(".vercol");
                      vers.children().removeClass('selected');//這個要將前一次的selected去掉.不然會累積一堆
                      var verses = vers.find('[sec=' + ps.sec + ']');
                      verses.addClass('selected');
                    }

                    setPageState(ps);
                    fhlInfo.render(ps);

                    // 因為搜尋還沒有加事件, 這個是暫時用的 2017.09
                    var idx = getBookFunc("index", ps.chineses);
                    ps.bookIndex = idx + 1; // 此idx回傳是 0-based

                    // 2017.08
                    if (oldsec != ps.sec || oldchap != ps.chap)
                      $(that).trigger('secchanged')
                  }
                }, '.lec');
                // sn 的部分
                $lecMain.on({
                  click: function () {
                    if (ps.realTimePopUp != 1) {
                      var offset = $(this).offset();
                      offset.top += $(this).height();
                      ps.N = $(this).attr('N');
                      // console.log($(this).html()) // &lt;09002&gt; 就是 <09002>
                      var k = $(this).html().replace(/&lt;/g, "").replace(/&gt;/g, "");
                      k = k.replace(/\(/g, "").replace(/\)/g, ""); // 可能是 (09002)
                      k = k.replace(/\{/g, "").replace(/\}/g, "");// 可能是 {09002}
                      ps.k = k; // 9002
                      parsingPopUp.render(ps, parsingPopUp.dom, offset);
                    }
                  },
                  mouseenter: function () {
                    if (ps.realTimePopUp == 1) {
                      var offset = $(this).offset();
                      //console.log(offset.top);
                      offset.top += $(this).height();
                      //console.log(offset.top);
                      //console.log('');
                      ps.N = $(this).attr('N');
                      var k = $(this).html().replace(/&lt;/g, "").replace(/&gt;/g, "");
                      k = k.replace(/\(/g, "").replace(/\)/g, "");
                      k = k.replace(/\{/g, "").replace(/\}/g, "");
                      ps.k = k;
                      setTimeout(function () { parsingPopUp.render(ps, parsingPopUp.dom, offset) }, 100);
                    }
                  },
                  mouseleave: function () {
                    if (ps.realTimePopUp == 1) {
                      $.data($('#parsingPopUp')[0], "parsingPopUpAutoCloseTimeout", setTimeout(function () {
                        if ($('#parsingPopUp').css('display') == 'block') {
                          $('#parsingPopUp').hide();
                        }
                      }, 100));
                    }
                  }
                }, '.sn');
                // 向後巡覽 / 向前巡覽
                var $vhb = $('#viewHistoryButton');
                $vhb.on({
                  click: function (e) {
                    $lecture.trigger('bclick');// fhlLecture
                  }
                }, '.b').on({
                  click: function (e) {
                    $lecture.trigger('nclick');// fhlLecture
                  }
                }, '.n');
                (function () {
                  function recolor(e, p1) {
                    /// <summary> 當 viewHistory 資料或 idx 變的時候, 要判斷是不是灰色 (document的vh_idxchanged事件與vh_itemschanged事件) </summary>
                    if (p1.datas.length - 1 == p1.idx)
                      $vhb.find('.b').css('color', 'darkgray');
                    else
                      $vhb.find('.b').css('color', 'black');
                    if (p1.idx == 0)
                      $vhb.find('.n').css('color', 'darkgray');
                    else
                      $vhb.find('.n').css('color', 'black');
                  }
                  $(document).on(
                    {
                      vh_idxchanged: recolor,
                      vh_itemschanged: recolor
                    });
                })();

                // .ft 注腳 click
                $lecMain.on({
                  click: function (e) {
                    //console.log(this); //範例: <span class=ft ft=42 ver=tcv chap=2>【42】</span>
                    // http://bkbible.fhl.net/json/rt.php?engs=Gen&chap=2&version=tcv&gb=0&id=42

                    var offset = $(this).offset();
                    offset.top += $(this).height() + 10;
                    parsingPopUp.render(ps, parsingPopUp.dom, offset, "ft");

                    var ftid = $(this).attr('ft');
                    var engs = $(this).attr('engs');
                    var chap = $(this).attr('chap');
                    var ver = $(this).attr('ver');

                    var url = "rt.php?engs=" + engs + "&chap=" + chap + "&version=" + ver + "&id=" + ftid;
                    if (ps.gb == 1)
                      url += "&gb=1";
                    fhl.json_api_text(url, function (a1, a2) {
                      var json = JSON.parse(a1);
                      if (json.status == "success" && json.record.length > 0) {
                        var txt = json.record[0].text;
                        $('#parsingPopUpInside').text(txt);
                        $('#parsingPopUpInside').css("width", "100%");
                        $('#parsingPopUpInside').css("max-width", "323px"); //cy:200px乘黃金比例1.618
                        $('#parsingPopUpInside').css("white-space", "normal");
                      }
                      else {
                        $('#parsingPopUpInside').text("錯誤:可回報下訊息- " + a1);
                      }
                    }, function (a1, a2) {
                      $('#parsingPopUpInside').text("錯誤:於" + url + "時發生");
                    }, null);
                  }
                }, '.ft');

                // 地圖(綠色那個)click時, 發出sobj_pos訊息給地圖那邊接受
                $lecMain.on({
                  'click': function (e) {
                    try {
                      var sobj = $(this).parent(".sobj");
                      var sid = sobj.attr('sid');
                      $(document).trigger('sobj_pos', { sid: sid });
                    } catch (ex) { }
                  }
                }, 'img.pos');
              };// fn.init

              fn.when_bclick_or_nclick = function (fnb, fnn) {
                /// <summary> fhlLecture 提供的 event </summary>
                /// <param type="fn(e)" name="fnb" parameterArray="false">older history view</param>
                /// <param type="fn(e)" name="fnn" parameterArray="false">newer history view</param>
                $lecture.on({
                  bclick: fnb,
                  nclick: fnn
                });
              };

              fn.selectLecture = function (book, chap, sec) {
                var that = this.dom;
                that.find('.lec').removeClass('selected');
                var obj = that.find('.lec' + '[sec="' + sec + '"]');
                if (obj) {
                  obj.addClass('selected');
                  if (obj.position()) {
                    var lecMain = $('#lecMain');
                    if (obj.position().top > lecMain.height() || obj.position().top < 0)
                      lecMain.scrollTop(lecMain.scrollTop() + obj.position().top - lecMain.height() / 2);
                    else
                      lecMain.scrollTop(lecMain.scrollTop());
                  }
                  else {
                    console.log("no position");
                  }
                }
              };
              fn.reshape = function (ps) {
                /// <summary> 目前主要是 mode=1 時, align 要重新排過, 會用到的有 fontSize, resize,(在windowAdjust裡呼叫) 裡面會有 show_mode 判斷式, 只要直接呼叫即可 </summary>
                if (ps.show_mode == 1) {
                  /// @verbatim 對齊必須在 dom.html(html) 之後才作, 因為那時候才會有實體, 否則取出來的 height() 會是 0@endverbatim
                  var $lecMain = $('#lecMain');
                  var cols = $lecMain.children();
                  var qcols = Enumerable.From(cols);
                  var qvers = qcols.Select(function (a1) { return $(a1).children(); });
                  // console.log(qvers.ToArray());
                  var maxRecordCnt = qvers.Max('$.length');
                  //console.log(maxRecordCnt);

                  for (var i = 0; i < maxRecordCnt; i++) {
                    var qvers2 =
                      qvers.Select(function (a1) { if (a1[i] == null) return null; return a1[i] });
                    qvers2.ForEach(function (a1) { if (a1 != null) $(a1).height('100%'); }); //要先變為auto, 才能正確算 最大的 cy
                    var maxcy = qvers2.Max(function (a1) { return a1 == null ? 0 : $(a1).height() });
                    //var maxcy = Math.max.apply(Math, qvers2.Select(function (a1) { return $(a1).height(); }).ToArray());
                    //console.log(maxcy);
                    qvers2.ForEach(function (a1) { if (a1 != null) $(a1).height(maxcy); });
                  }
                }
              };

              fn.registerEvents = function (ps) {
                var that = this.dom;

                // snow add
                var $lecMain = $('#lecMain');
                var mode = $lecMain.attr('mode'); //0: 原本, 1:好選擇

                // 移到 init 完成
                //that.find('.lec').click(function(){

                // 移到 init 完成
                //$('.versionName').click(function(e){

                // 移到 init 完成
                //if(ps.realTimePopUp==1){

                //下面3個已經拉到 init , 只需1次
                //$('.chapBack').click(function(e){});
                //$('.chapNext').click(function(e){});
                //$('#lecMain').scroll(function () { });

                // .ft click 也移到 init 完成
              };
              fn.render = function (ps, dom) {
                //console.log('start of fhlLecture render');
                function reverse(s) {
                  var o = '';
                  for (var i = s.length - 1; i >= 0; i--)
                    o += s[i];
                  return o;
                }
                var $lec = $(this.dom);
                var that = this;
                var htmlTitle = "";
                var htmlContent = "";
                var col = ps.version.length;
                var rspArr = new Array();
                var idx = 0;
                getBibleText(col, ps, function (o) {
                  rspArr.push(o);
                }, function () {
                  var isOld = checkOldNew(ps);
                  var maxRecordCnt = 0;
                  var maxRecordIdx = 0;
                  rspArr = sortBibleVersion(rspArr, ps);

                  // nextchap prevchap
                  var bookName = getBookFunc("bookFullName", ps.chineses);
                  if (bookName != "failed") {
                    if (ps.chineses == book[0] && ps.chap == 1) {
                      $lec.find('.chapBack').first().css('display', 'none');
                    } else {
                      $lec.find('.chapBack').first().css('display', 'block');
                    }
                    if (ps.chineses == book[65] && ps.chap == 22) {
                      $lec.find('.chapNext').first().css('display', 'none');
                    } else {
                      $lec.find('.chapNext').first().css('display', 'block');
                    }
                  }

                  // title
                  var dtitle = $('#lecMainTitle');
                  dtitle.empty();
                  for (var i = 0; i < rspArr.length; i++) {
                    var o = rspArr[i];
                    if (o.v_name === "原文直譯(參考用)")
                      dtitle.append($("<div class=lecContent><div class=versionName>" + o.v_name + "<span class='closeButton' cname='" + "原文直譯" + "'>&#215</span></div></div>"));
                    else
                      dtitle.append($("<div class=lecContent><div class=versionName>" + o.v_name + "<span class='closeButton' cname='" + o.v_name + "'>&#215</span></div></div>"));

                    if (rspArr[i].record_count > maxRecordCnt) {
                      maxRecordCnt = rspArr[i].record_count;
                      maxRecordIdx = i;
                      //console.log("maxRecordCnt:"+maxRecordCnt+",maxRecordIdx:"+maxRecordIdx);
                    }
                  }

                  //var mode = 1;// 原本的. 就切回0
                  var mode = ps.show_mode;
                  switch (mode) {
                    case 0:
                      {
                        // 每一節 i, 以最大的那個版本為主 maxR
                        for (var i = 0; i < maxRecordCnt; i++) {
                          var maxR = rspArr[maxRecordIdx].record[i];
                          htmlContent += "<div class=lec style='font-size: " + ps.fontSize + "pt; line-height: " + ps.fontSize * 1.25 + "pt; margin-top: " + (ps.fontSize * 1.25 - 15) + "px'>";
                          //htmlContent+="<div class=lecTitle>"+maxR.chap+":"+maxR.sec+"</div>";
                          for (j = 0; j < rspArr.length; j++) {
                            var chap = maxR.chap, sec = maxR.sec;
                            var rec = getRecord(rspArr[j].record, null, chap, sec);
                            //var r=rspArr[j].record[i];
                            if (rec != null) {
                              var bibleText = parseBibleText(rec.bible_text, ps, isOld, rspArr[j].v_name);
                              if (bibleText == "a")
                                bibleText = "【併入上節】";
                            } else {
                              bibleText = "";
                            }
                            if (rspArr[j].version == "bhs") {
                              var bibleText = bibleText.split(/\n/g).reverse().join("<br>");
                              //console.log(bibleText);
                            }
                            else if (rspArr[j].version == "cbol") {
                              var bibleText = bibleText.split(/\n/g).join("<br>");
                              //console.log(bibleText);
                            }
                            else if (rspArr[j].version == "nwh") {
                              var bibleText = bibleText.split(/\n/g).join("<br>");
                            }

                            var className = '';
                            if (rspArr[j].version == "thv12h") // 2018.01 客語特殊字型(太1)
                              className += 'bstw '

                            htmlContent += "<div class='lecContent " + rspArr[j].version + "'><div class='bstw' style='margin: 0px 20px 0px 1px; padding: 7px 0px; height: 100%;'><span class='verseNumber'>" + maxR.sec + "</span><span class='verseContent'>" + bibleText + "</span></div></div>";
                          }
                          htmlContent += "</div>";
                        }
                      }
                      break;
                    case 1:
                      {
                        // 注意, 這個變數, 只是暫存的, 它輽出的結果是 html 文字, 不包含自己, 所以lecMain屬性是在另種設定, 不是在這
                        // 不要再從這裡改 <div style=padding:10px 50px></div>, 不會有效果的.
                        var $htmlContent = $("<div id='lecMain'></div>");

                        var cx1 = 100 / rspArr.length;
                        for (j = 0; j < rspArr.length; j++) {
                          // 分3欄
                          var onever = $("<div class='vercol' style='width:" + cx1 + "%;display:inline-block;vertical-align:top;font-size: " + ps.fontSize + "pt; line-height: " + ps.fontSize * 1.25 + "pt; margin-top: " + (ps.fontSize * 1.25 - 15) + "px'></div>");
                          $htmlContent.append(onever);
                        }

                        // 每1欄內容
                        for (j = 0; j < rspArr.length; j++) { //each version
                          for (var i = 0; i < rspArr[j].record_count; i++) {//each sec
                            var maxR = rspArr[j].record[i]; //原 var maxR = rspArr[maxRecordIdx].record[i];
                            var chap = maxR.chap, sec = maxR.sec;
                            var rec = rspArr[j].record[i]; //原 var rec = getRecord(rspArr[j].record, null, chap, sec);
                            var bibleText = "";
                            if (rec != null)
                              bibleText = parseBibleText(rec.bible_text, ps, isOld, rspArr[j].v_name);
                            else
                              bibleText = "";
                            if (bibleText == "a") {
                              bibleText = "【併入上節】";
                            }

                            if (rspArr[j].version == "bhs") {
                              bibleText = bibleText.split(/\n/g).reverse().join("<br>");
                              //console.log(bibleText);
                            }
                            else if (rspArr[j].version == "cbol") {
                              bibleText = bibleText.split(/\n/g).join("<br>");
                              //console.log(bibleText);
                            }
                            else if (rspArr[j].version == "nwh") {
                              bibleText = bibleText.split(/\n/g).join("<br>");
                            }

                            // 2018.01 客語特殊字型(太1)
                            var className = 'verseContent ';
                            if (rspArr[j].version == "thv12h" || rspArr[j].version == 'ttvh')
                              className += ' bstw'

                            $htmlContent.children().eq(j).append(
                              $("<div ver='" + rspArr[j].version + "' chap=" + chap + " sec=" + sec + " class='lec'><div style='margin: 0px 20px 0px 1px; padding: 7px 0px; height: 100%;'><span class='verseNumber'>" + sec + "</span><span class='"+className+"'>" + bibleText + "</span></div></div>"));

                          }//for each verse
                        }//for each version

                        // add 2016.10 地圖與照片
                        if (ps.ispos || ps.ispho) {
                          var url2 = "sobj.php?engs=" + ps.engs + "&chap=" + ps.chap;
                          if (ps.gb == 1)
                            url2 += "&gb=1";
                          fhl.json_api_text(url2, function (aa1, aa2) {
                            var jrr1 = JSON.parse(aa1);
                            //console.log(jrr1);

                            var id2reg = {};
                            var id2obj = {};
                            $.each(jrr1.record, function (aaa1, aaa2) {
                              var id = aaa2.id.toString();
                              var nas = {};//Egyte,埃及,埃及. 就可以排除同樣名稱的
                              nas[aaa2.cname] = 1;
                              nas[aaa2.c1name] = 1;
                              nas[aaa2.c2name] = 1;
                              if (aaa2.ename != null && aaa2.ename.trim().length != 0)
                                nas["[ ,\\n:;\\.]" + aaa2.ename + "[ ,\\n:;\\.]"] = 1;//斷開英文可能結尾「空白,逗號,句號,冒號, 2016.11
                              //nas[aaa2.ename] = 1;

                              var nas2 = [];
                              $.each(nas, function (b1, b2) {
                                // 2016.10 nas2 若出現 ()會造成一定成立.
                                if (b1 != null && b1.trim().length != 0)
                                  nas2.push(b1);
                              });

                              var regstr = "((" + nas2.join(")|(") + "))"; // ((羅馬)|([空白字元]Rome[空白字元]))
                              var regex = new RegExp(regstr, "i");
                              id2obj[id] = aaa2;
                              id2reg[id] = regex;
                            }, null);
                            $htmlContent.find(".verseContent").each(function (c1, c2) {
                              var str = c2.innerHTML;
                              var ischanged = false;

                              // 每1節都要測所有的 regex, 並取代
                              $.each(id2reg, function (b1, b2) {
                                var b3 = id2obj[b1];
                                var issite = b3.objpath == null || b3.objpath.trim().length == 0 ? false : true;
                                var isphoto = true; //目前無法判定是不是相片,全都當是 TODO

                                // 再優化部分(能不regex,就略過)
                                if (ps.ispos && ps.ispho == false && issite == false)
                                  return;//next reg
                                else if (ps.ispho && ps.ispos == false && isphoto == false)
                                  return;//next reg

                                if (b2.test(str)) {
                                  ischanged = true;
                                  //var strpho = (ps.ispho == false || isphoto == false) ? "" : "<img class='pho'></img>";
                                  var strpho = (ps.ispho == false || isphoto == false) ? "" : "<a target='_blank' href='http://bible.fhl.net/object/sd.php?gb=0&LIMIT=" + b1 + "'><img class='pho'></img></a>";
                                  var strsite = (ps.ispos == false || issite == false) ? "" : "<img class='pos'></img>";

                                  str = str.replace(b2, "<span class='sobj' sid=" + b1 + "><span>$1</span>" + strsite + strpho + "</span>");

                                }
                              });

                              if (ischanged) {
                                c2.innerHTML = str;
                              }
                            });//each
                            htmlContent = $htmlContent.html();//.html()不包含自己 ... 所以這裡不是設 lecMain 有用的地方
                          }, function (aa1, aa2) {
                            console.error(aa1);
                          }, null, false); //第4個參數要false,要同步,否則$htmlContent還沒好就被拿來用會出問題
                        }
                        else
                          htmlContent = $htmlContent.html();//.html()不包含自己 ... 所以這裡不是設 lecMain 有用的地方

                      }
                      break;
                    case 2:
                      {
                        // 注意, 這個變數, 只是暫存的, 它輽出的結果是 html 文字, 不包含自己, 所以lecMain屬性是在另種設定, 不是在這
                        // 不要再從這裡改 <div style=padding:10px 50px></div>, 不會有效果的.
                        var $htmlContent = $("<div id='lecMain'></div>");

                        var onever = $("<div class='vercol' style='vertical-align:top;font-size: " + ps.fontSize + "pt; line-height: " + ps.fontSize * 1.25 + "pt; margin-top: " + (ps.fontSize * 1.25 - 15) + "px'></div>");
                        $htmlContent.append(onever);

                        // 每一節內容
                        for (var i = 0; i < maxRecordCnt; i++) {
                          var maxR = rspArr[maxRecordIdx].record[i]; //原 var maxR = rspArr[maxRecordIdx].record[i];
                          var chap = maxR.chap, sec = maxR.sec;

                          for (var j = 0; j < rspArr.length; j++) {
                            var r1 = rspArr[j];
                            if (rspArr.length > 1)
                              var vname = "<span class='ver'> (" + r1.v_name + ")</span> "; //新譯本 合和本 etc
                            else
                              var vname = ""; //只有一種版本就不要加了

                            if (i >= r1.record_count) {
                              //此版本 本章節比較少,
                              var className = 'verseContent ';
                              if (rspArr[j].version == "thv12h" || rspArr[j].version == 'ttvh') // 2018.01 客語特殊字型(太1)
                                className += ' bstw'

                              onever.append(
                                $("<div ver='" + rspArr[j].version + "' chap=" + chap + " sec=" + sec + " class='lec'><div style='margin: 0px 20px 0px 1px; padding: 7px 0px; height: 100%;'><span class='verseNumber'>" + sec + "</span><span class='"+className+"'>" + vname + "</span></div></div>"));
                            }
                            else {

                              var rec = rspArr[j].record[i]; //原 var rec = getRecord(rspArr[j].record, null, chap, sec);
                              var bibleText = "";
                              if (rec != null)
                                bibleText = parseBibleText(rec.bible_text, ps, isOld, rspArr[j].v_name);
                              else
                                bibleText = "";
                              if (bibleText == "a") {
                                bibleText = "【併入上節】";
                              }
                              if (rspArr[j].version == "bhs") {
                                bibleText = bibleText.split(/\n/g).reverse().join("<br>");
                                //console.log(bibleText);
                              }
                              else if (rspArr[j].version == "cbol") {
                                bibleText = bibleText.split(/\n/g).join("<br>");
                                //console.log(bibleText);
                              }
                              else if (rspArr[j].version == "nwh") {
                                bibleText = bibleText.split(/\n/g).join("<br>");
                              }

                              var className = 'verseContent';
                              if (rspArr[j].version == "thv12h" || rspArr[j].version == 'ttvh') // 2018.01 客語特殊字型(太1)
                                className += ' bstw'
                              console.log(rspArr)
                              onever.append(
                                $("<div ver='" + rspArr[j].version + "' chap=" + chap + " sec=" + sec + " class='lec'><div style='margin: 0px 20px 0px 1px; padding: 7px 0px; height: 100%;'><span class='verseNumber'>" + sec + "</span><span class='"+className+"'>" + bibleText + vname + "</span></div></div>"));

                            }

                          }
                        }

                        // add 2016.10 地圖與照片
                        if (ps.ispos || ps.ispho) {
                          var url2 = "sobj.php?engs=" + ps.engs + "&chap=" + ps.chap;
                          if (ps.gb == 1)
                            url2 += "&gb=1";
                          fhl.json_api_text(url2, function (aa1, aa2) {
                            var jrr1 = JSON.parse(aa1);
                            //console.log(jrr1);

                            var id2reg = {};
                            var id2obj = {};
                            $.each(jrr1.record, function (aaa1, aaa2) {
                              var id = aaa2.id.toString();
                              var nas = {};
                              nas[aaa2.cname] = 1;
                              nas[aaa2.c1name] = 1;
                              nas[aaa2.c2name] = 1;
                              nas[aaa2.ename] = 1;

                              var nas2 = [];
                              $.each(nas, function (b1, b2) {
                                // 2016.10 nas2 若出現 ()會造成一定成立.
                                if (b1 != null && b1.trim().length != 0)
                                  nas2.push(b1);
                              });

                              var regstr = "((" + nas2.join(")|(") + "))"; // ((羅馬)|(Rome))
                              var regex = new RegExp(regstr, "i");
                              id2obj[id] = aaa2;
                              id2reg[id] = regex;
                            }, null);
                            $htmlContent.find(".verseContent").each(function (c1, c2) {
                              var str = c2.innerHTML;
                              var ischanged = false;

                              // 每1節都要測所有的 regex, 並取代
                              $.each(id2reg, function (b1, b2) {
                                var b3 = id2obj[b1];
                                var issite = b3.objpath == null || b3.objpath.trim().length == 0 ? false : true;
                                var isphoto = true; //目前無法判定是不是相片,全都當是 TODO

                                // 再優化部分(能不regex,就略過)
                                if (ps.ispos && ps.ispho == false && issite == false)
                                  return;//next reg
                                else if (ps.ispho && ps.ispos == false && isphoto == false)
                                  return;//next reg

                                if (b2.test(str)) {
                                  ischanged = true;
                                  //var strpho = (ps.ispho == false || isphoto == false) ? "" : "<img class='pho'></img>";
                                  var strpho = (ps.ispho == false || isphoto == false) ? "" : "<a target='_blank' href='http://bible.fhl.net/object/sd.php?gb=0&LIMIT=" + b1 + "'><img class='pho'></img></a>";
                                  var strsite = (ps.ispos == false || issite == false) ? "" : "<img class='pos'></img>";

                                  str = str.replace(b2, "<span class='sobj' sid=" + b1 + "><span>$2</span>" + strsite + strpho + "</span>");
                                }
                              });

                              if (ischanged) {
                                c2.innerHTML = str;
                              }
                            });//each
                            htmlContent = $htmlContent.html();//.html()不包含自己 ... 所以這裡不是設 lecMain 有用的地方
                          }, function (aa1, aa2) {
                            console.error(aa1);
                          }, null, false); //第4個參數要false,要同步,否則$htmlContent還沒好就被拿來用會出問題
                        }
                        else
                          htmlContent = $htmlContent.html();//.html()不包含自己 ... 所以這裡不是設 lecMain 有用的地方
                      } break;
                  }


                  $lec.find('#lecMain').first()
                    .html(htmlContent)
                    .attr('mode', mode);

                  fhlLecture.reshape(ps);

                  // 2016.01.21(四) 版權宣告 snow
                  {
                    var div_copyrigh = $('<div id="div_copyright" class="lec copyright"></div>');
                    $('#lecMain').append(div_copyrigh); // 放在 lecMain 才會在最下面. 因為 parent 有設 position 屬性
                    rr = React.createElement(copyright_api.R.frame, { ver: ps.version });
                    ss = React.render(rr, document.getElementById("div_copyright"));  // snow add 2016.01.21(四),
                    // bug 小心: 版權宣告 render 必須在 dom.html 之後唷, 這樣才找到的 divCopyright 實體
                  }

                  if (mode == 0) {
                    for (var i = 0; i < maxRecordCnt; i++) {
                      var r = rspArr[maxRecordIdx].record[i];
                      dom.find('.lec:eq(' + i + ')').attr('chap', r.chap);
                      dom.find('.lec:eq(' + i + ')').attr('sec', r.sec);
                    }
                  }
                  setCSS(col, ps);
                  setFont();
                  that.selectLecture(null, null, ps.sec);

                  {// 2016.08 snow, 注腳
                    $lec.find('.lec').each(function (a1, a2) {
                      var ver = $(a2).attr('ver');
                      $(this).find('.verseContent').each(function (aa1, aa2) {
                        aa2.innerHTML = aa2.innerHTML.replace(/【(\d+)】/g, "<span class=ft ft=$1 ver='" + ver + "' chap=" + ps.chap + " engs='" + ps.engs + "'>【$1】</span>");
                      });

                      //if ( ver == 'fhlwh')
                      //{// 2016.10 snow, 新約原文,要套用字型 (剛剛好也是每個 .lec, 所以就搭注腳的forEach順風車)
                      //  $(a2).css('font-family', 'COBSGreekWeb');
                      //  		}
                    });
                  }



                  that.registerEvents(ps);


                });
              };

              return new FhlLecture();
            })();

            // 2017.08
            $(function () {
              $(fhlUrlParameter).on('bible', function () {
                // console.log(fhlUrlParameter.bibleResult) // {book: 1, chap: 12, sec: 9}
                if (pageState != undefined) {
                  pageState.chineses = FHL.CONSTANT.Bible.CHINESE_BOOK_ABBREVIATIONS[fhlUrlParameter.bibleResult.book - 1]
                  pageState.engs = FHL.CONSTANT.Bible.ENGLISH_BOOK_ABBREVIATIONS[fhlUrlParameter.bibleResult.book - 1]
                  if (fhlUrlParameter.bibleResult.book > 0) {

                    pageState.bookIndex = fhlUrlParameter.bibleResult.book
                    pageState.chap = fhlUrlParameter.bibleResult.chap >= 0 ? fhlUrlParameter.bibleResult.chap : 1
                    pageState.sec = fhlUrlParameter.bibleResult.sec >= 0 ? fhlUrlParameter.bibleResult.sec : 1

                    fhlLecture.render(pageState, fhlLecture.dom); // 內容
                    bookSelect.render(pageState, bookSelect.dom); // 內容的 title
                  }
                }
              }) // bible event
              $(window).trigger('hashchange')

              $(fhlLecture).on('chapchanged', function () {
                var bookEn = FHL.CONSTANT.Bible.ENGLISH_BOOK_SHORT_ABBREVIATIONS[pageState.bookIndex - 1]
                history.pushState(null, null, '#/bible/' + bookEn + '/' + pageState.chap)
              });
              $(fhlLecture).on('secchanged', function () {
                var bookEn = FHL.CONSTANT.Bible.ENGLISH_BOOK_SHORT_ABBREVIATIONS[pageState.bookIndex - 1];
                history.replaceState(null, null, '#/bible/' + bookEn + '/' + pageState.chap + '/' + pageState.sec)
              });
              $(fhlLecture).trigger('secchanged')

              $(bookSelectChapter).on('chapchanged', function () {
                var bookEn = FHL.CONSTANT.Bible.ENGLISH_BOOK_SHORT_ABBREVIATIONS[pageState.bookIndex - 1]
                history.pushState(null, null, '#/bible/' + bookEn + '/' + pageState.chap)
              })
            });


            var fhlMidBottomWindow = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, dom);
                this.registerEvents(ps);
              },
              registerEvents: function (ps) {
                $('#fhlMidBottomWindow').resizable({
                  handles: 'n',
                  maxHeight: 600,
                  minHeight: 100,
                  resize: function (event, ui) {
                    var height = $('#mainWindow').height() - ui.size.height - 115 + 15;
                    $("#fhlLecture").css({
                      'height': height + 'px',
                    });
                    $(this).css({
                      'width': '100%'
                    });
                  }
                });
                $('.ui-resizable-handle.ui-resizable-n').html('<span>&#9776;</span>');
              },
              render: function (ps, dom) {
                $('#fhlMidBottomWindow').css({ 'top': $('#fhlLecture').height() + 12 + 'px' });
                var div_pre_search = document.createElement("div");
                div_pre_search.id = "pre_search";
                $(div_pre_search).css("font-size", "10pt");
                var div_search_result = document.createElement("div");
                div_search_result.id = "search_result";
                $(div_search_result).css("font-size", "10pt");
                document.getElementById("fhlMidBottomWindowContent").innerHTML = "";
                document.getElementById("fhlMidBottomWindowContent").appendChild(div_pre_search);
                document.getElementById("fhlMidBottomWindowContent").appendChild(div_search_result);
              }
            };
            /***** End of fhlMidWindow *****/

            /***** Start of fhlInfo *****/
            var fhlInfo = {
              init: function (ps) {
                bibleAudio.init(ps, $('#bibleAudio'));
                bibleAudio.registerEvents(ps);
                fhlInfoTitle.init(ps, $('#fhlInfoTitle'));
                fhlInfoTitle.registerEvents(ps);
                fhlInfoContent.init(ps, $('#fhlInfoContent'));
                fhlInfoContent.registerEvents(ps);
                parsingPopUp.init(ps, $('#parsingPopUp'));
                this.registerEvents();
                this.render(ps);
                var fhlInfoWidth = 500;//這邊改了，css裡面也要改
                $('#fhlInfo').css({ 'left': $(window).width() - fhlInfoWidth - 12 + 'px' });// 12 是外面border

                // snow add, 2016.10 經文中的地點mark被click,
                $(document).on({
                  'sobj_pos': function (e, p1) {
                    if (ps.titleId == "fhlInfoMap") {
                      rfhlmap.set_active(p1.sid);
                    }
                  }
                });
              },
              registerEvents: function () {
                $('#fhlInfo').resizable({
                  handles: 'w',
                  maxWidth: 1000,
                  minWidth: 300,
                  resize: function (event, ui) {
                    var currentWidth = ui.size.width;
                    var width = 0;
                    if ($("#fhlLeftWindow").css('left') == '12px')
                      width = $(window).width() - $("#fhlLeftWindow").width() - currentWidth;
                    else
                      width = $(window).width() - currentWidth + 12;
                    $("#fhlMidWindow").css({
                      'width': width - 48 + 'px',
                      'right': currentWidth + 'px'
                    });

                    // snow add 2016-07
                    fhlLecture.reshape(pageState);
                  }
                });
                $('.ui-resizable-handle.ui-resizable-w').html('<span>&#9776;</span>');
              },
              render: function (ps) {
                //fhlInfoTitle.render(ps,$('#fhlInfoTitle'));
                fhlInfoContent.render(ps, fhlInfoContent.dom);
              }
            };

            var bibleAudio = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {

              },
              render: function (ps, dom) {
                //var html="有聲聖經 ";
                //if(ps.chineses==book[0]&&ps.chap==1){
                //  html+="";
                //}else{
                //  html+="<img class='menuImage' src='./static/images/lastChapter.png'/>";
                //}
                //if(ps.audio==0){
                //  html+="<img class='menuImage' src='./static/images/audioPlay.png'/>";
                //}else{
                //  html+="<img class='menuImage' src='./static/images/audioPause.png'/>";
                //}
                //if(ps.chineses==book[65]&&ps.chap==22){
                //  html+="";
                //}else{
                //  html+="<img class='menuImage' src='./static/images/nextChapter.png'/>";
                //}
                //dom.html(html);
              }
            }

            var fhlInfoTitle = {
              init: function (ps, dom) {
                this.dom = dom;
                this.title = [
                  { "name": "原文", "id": "fhlInfoParsing" },
                  { "name": "註釋", "id": "fhlInfoComment" },
                  { "name": "講道", "id": "fhlInfoPreach" },
                  { "name": "串珠", "id": "fhlInfoTsk" },
                  { "name": "典藏", "id": "fhlInfoOb" },
                  { "name": "有聲", "id": "fhlInfoAudio" },
                  { "name": "地圖", "id": "fhlInfoMap" }
                ];
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                //select all elements of info title
                var selectAll = "";
                for (var i = 0; i < this.title.length; i++) {
                  selectAll += "#" + this.title[i].id + ",";
                }
                selectAll = selectAll.substring(0, selectAll.length - 1);
                $(selectAll).click(function () {
                  $(selectAll).removeClass('selected');
                  $(this).addClass('selected');
                  ps.titleIdold = ps.titleId; // add 2015.12.10(四) 為了有聲聖經,切換問題
                  ps.titleId = $(this).attr('id');
                  setPageState(ps);
                  fhlInfoContent.render(ps, fhlInfoContent.dom);
                });
              },
              render: function (ps, dom) {
                var html = "<ul>";
                for (var i = 0; i < this.title.length; i++) {
                  html += "<li>" + this.title[i].name + "</li>";
                }
                html += "</ul>";
                dom.html(html);
                for (var i = 0; i < this.title.length; i++) {
                  dom.find('li:eq(' + i + ')').attr('id', this.title[i].id);
                }
                $('#' + ps.titleId).addClass('selected');
              }
            };

            var fhlInfoContent = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                var that = this;
                switch (ps.titleId) {
                  case "fhlInfoParsing":
                    if (ps.realTimePopUp == 1) {
                      $('.parsing').mouseenter(function () {
                        var offset = $(this).offset();
                        offset.top += $(this).height() + 10;
                        ps.N = $(this).attr('N');
                        ps.k = $(this).attr('k');
                        var par = decodeURIComponent($(this).attr('par'));
                        parsingPopUp.render(ps, parsingPopUp.dom, offset, par);
                      });
                      /*$('.parsing').mouseleave(function(){
                        parsingPopUp.dom.hide();
                      });*/
                      $('.parsingTableSn').mouseenter(function () {
                        var offset = $(this).offset();
                        offset.top += $(this).height() + 10;
                        ps.N = $(this).attr('N');
                        ps.k = $(this).attr('k');
                        parsingPopUp.render(ps, parsingPopUp.dom, offset);
                      });
                      /*$('.parsingTable').mouseleave(function(){
                        parsingPopUp.dom.hide();
                      });*/
                    } else {
                      $('.parsing').click(function () {
                        var offset = $(this).offset();
                        offset.top += $(this).height() + 10;
                        ps.N = $(this).attr('N');
                        ps.k = $(this).attr('k');
                        var par = decodeURIComponent($(this).attr('par'));
                        parsingPopUp.render(ps, parsingPopUp.dom, offset, par);
                      });
                      $('.parsingTableSn').click(function () {
                        var offset = $(this).offset();
                        offset.top += $(this).height() + 10;
                        ps.N = $(this).attr('N');
                        ps.k = $(this).attr('k');
                        parsingPopUp.render(ps, parsingPopUp.dom, offset);
                      });
                    }

                    $('.parsingTableSn').mouseleave(function () {
                      if (ps.realTimePopUp == 1) {
                        $.data($('#parsingPopUp')[0], "parsingPopUpAutoCloseTimeout", setTimeout(function () {
                          if ($('#parsingPopUp').css('display') == 'block') {
                            $('#parsingPopUp').hide();
                          }
                        }, 100));
                      }
                    });
                    $('.parsingSecBack, .parsingSecNext').click(function () {
                      var oldEngs = ps.engs;
                      var oldChap = ps.chap;
                      ps.engs = $(this).attr('engs');
                      var idx = getBookFunc('indexByEngs', ps.engs);
                      ps.chineses = book[idx];
                      ps.chap = $(this).attr('chap');
                      ps.sec = $(this).attr('sec');
                      setPageState(ps);
                      bookSelect.render(ps, bookSelect.dom);
                      if (oldEngs != ps.engs || oldChap != ps.chap)
                        fhlLecture.render(ps, fhlLecture.dom);
                      fhlInfo.render(ps);
                      fhlLecture.selectLecture(null, null, ps.sec);
                      viewHistory.render(ps, viewHistory.dom);
                    });
                    break;
                  case "fhlInfoComment":
                    // 2017.12
                    $('.sn').click(function () {
                      var sn = $(this).attr('sn');
                      var offset = $(this).offset();
                      offset.top += $(this).height() + 10;
                      // ps.N = $(this).attr('N');
                      ps.N = 1;
                      ps.k = sn;
                      parsingPopUp.render(ps, parsingPopUp.dom, offset, null);
                    });

                    $('.commentSecBack, .commentSecNext, .commentJump').click(function () {
                      var oldEngs = ps.engs;
                      var oldChap = ps.chap;
                      ps.engs = $(this).attr('engs');
                      var idx = getBookFunc('indexByEngs', ps.engs);
                      ps.chineses = book[idx];
                      ps.chap = $(this).attr('chap');
                      ps.sec = $(this).attr('sec');
                      setPageState(ps);
                      bookSelect.render(ps, bookSelect.dom);
                      /*if(oldEngs!=ps.engs||oldChap!=ps.chap)
                        fhlLecture.render(ps,fhlLecture.dom);*/
                      fhlLecture.render(ps, fhlLecture.dom);
                      fhlInfo.render(ps);
                      $('#fhlInfoContent').scrollTop(0);
                      viewHistory.render(ps, viewHistory.dom);
                    });

                    $('.commentBackground').click(function () {
                      if (ps.chap != 0 && ps.chap != 0) {
                        ps.commentBackgroundChap = ps.chap;
                        ps.commentBackgroundSec = ps.sec;
                        ps.engs = $(this).attr('engs');
                        var idx = getBookFunc('indexByEngs', ps.engs);
                        ps.chineses = book[idx];
                        ps.chap = $(this).attr('chap');
                        ps.sec = $(this).attr('sec');
                        fhlInfo.render(ps);
                        $('#fhlInfoContent').scrollTop(0);
                      }
                      else {
                        ps.chap = ps.commentBackgroundChap;
                        ps.sec = ps.commentBackgroundSec;
                        fhlInfo.render(ps);
                      }
                    });

                    $('.commentJump').css({
                      "display": "inline-block",
                      "cursor": "pointer",
                      "color": "rgba(50, 50, 100, 1)"
                    }).hover(function () {
                      $(this).css({
                        "color": "rgba(200, 0, 0, 1)",
                        "text-decoration": "underline"
                      });
                    }, function () {
                      $(this).css({
                        "color": "rgba(50, 50, 100, 1)",
                        "text-decoration": "none"
                      });
                    }
                      );
                    $('#commentScrollDiv').scroll(function () {
                      $(this).addClass('scrolling');
                      clearTimeout($.data(this, "scrollCheck"));
                      $.data(this, "scrollCheck", setTimeout(function () {
                        $('#commentScrollDiv').removeClass('scrolling');
                      }, 350));
                    });
                    break;
                  default:
                    break;
                }
              },
              render: function (ps, dom) {
                var that = this;
                switch (ps.titleId) {
                  case "fhlInfoParsing":
                    var html = "";
                    var ajaxUrl = getAjaxUrl("qp", ps);
                    $.ajax({
                      url: ajaxUrl
                    }).done(function (d, s, j) {
                      //console.log(d);// d 是回傳 純文字版, 但直接 JSON.parse 就要要用到的資料 (羅16:24有問題)
                      //console.log(s);// s 是回傳 success 字串
                      //console.log(j);// j 是回傳 ??物件, 總之 j.responseText 即是 d
                      if (j) {
                        var jsonObj = JSON.parse(j.responseText);
                        // console.log(jsonObj);
                        var v_name = jsonObj.v_name;
                        var version = jsonObj.version;
                        var prev_chineses = jsonObj.prev.chineses;
                        var prev_engs = jsonObj.prev.engs;
                        var prev_chap = jsonObj.prev.chap;
                        var prev_sec = jsonObj.prev.sec;
                        var next_chineses = jsonObj.next.chineses;
                        var next_engs = jsonObj.next.engs;
                        var next_chap = jsonObj.next.chap;
                        var next_sec = jsonObj.next.sec;
                        var proc = jsonObj.proc;
                        var div_name = ps.titleId;
                        if (version == "cbol") proc = 10;//原文直譯
                        var orig_font;
                        var head_str = "";
                        var chap_ctrl_str = "";
                        var body_str = "";
                        var clrstr = "";
                        var clrcnt = 0;
                        var N = jsonObj.N;
                        if (N == 0) orig_font = "g1";
                        else orig_font = "g2";
                        var html = jsonObj.N + "</br>";
                        for (var i = 0; i < jsonObj.record.length; i++) {
                          var wid = jsonObj.record[i].wid;
                          var word = jsonObj.record[i].word;
                          //console.log("word= " + word);
                          var exp = jsonObj.record[i].exp;
                          var id = jsonObj.record[i].id;
                          var parallel = "";
                          var align_str = "";
                          if (wid == 0) {
                            // 處理上面半部, 原文與中文部分 wid = 0 ( 下面 wid != 就是畫成 table 部分 )
                            if (N == 0)//NT (新約)
                            {
                              var wstr = "";
                              var wd = word.split("+");
                              //console.log("wd= " + wd);
                              if (wd.length > 0) {
                                for (var ii = 0; ii < wd.length; ii++) {
                                  if (ii % 3 == 0)
                                    wstr = wstr + wd[ii];
                                  else if (ii % 3 == 1)
                                    wstr = wstr + "(韋：" + wd[ii] + ")";
                                  else if (ii % 3 == 2)
                                    wstr = wstr + "(聯：" + wd[ii] + ")";
                                }
                                word = wstr;
                                //console.log(word);
                              }
                            }
                            else if (N == 1) //OT (舊約)
                            {
                              var remark = jsonObj.record[i].remark;
                              var engs = jsonObj.record[i].engs;
                              if (remark.length > 0) {
                                parallel = "平行經文：" + remark;
                              }
                              align_str = "align=\"right\" style=\"padding:0px 10px 0px 0px;\"";
                            }

                            var bookName = getBookFunc("bookFullName", ps.chineses);

                            // record[0]中的 word,
                            if (bookName != "failed") {
                              if (ps.chineses == book[0] && ps.chap == 1 && ps.sec == 1) {
                                chap_ctrl_str += "";
                              } else {
                                chap_ctrl_str += "<div class='parsingSecBack' ";
                                chap_ctrl_str += "engs=" + prev_engs + " chap=" + prev_chap + " sec=" + prev_sec;
                                chap_ctrl_str += "><span>&#x276e;</span></div>";
                              }
                              if (ps.chineses == book[65] && ps.chap == 22 && ps.sec == 21) {
                                chap_ctrl_str += "";
                              } else {
                                chap_ctrl_str += "<div class='parsingSecNext' ";
                                chap_ctrl_str += "engs=" + next_engs + " chap=" + next_chap + " sec=" + next_sec;
                                chap_ctrl_str += "><span>&#x276f;</span></div>";
                              }
                              chap_ctrl_str += "<div style='position: absolute; top: 10px; left: 15px; /*transform: translate(-50%, 0%);*/ font-size: 12pt; color: rgba(100, 100, 100, 0.5);'>" + bookName;
                              chap_ctrl_str += "&nbsp&nbsp" + ps.chap + ":" + ps.sec + "</div>";
                            }
                            /*
                            var poverhead="",noverhead="";
                            if (prev_chineses!=chineses||prev_chap!=chap)
                                poverhead=";Gclick=false;Gsec="+prev_sec+";read_bible('"+chineses+"',"+prev_chap+");";
                            if (next_chineses!=chineses||next_chap!=chap)
                                noverhead=";Gclick=false;Gsec="+next_sec+";read_bible('"+chineses+"',"+next_chap+");";
                                head_str="<span style=\"font-size:150%;\"><a href=\"javascript:spar('"+prev_engs+"',"+prev_chap+","+prev_sec+",'"+div_name+"')"+
                                poverhead+"\">&lt;</a> <span class=\"psn\">"+
                                chinesef+"  "+chap+":"+sec
                                +"</span> <a href=\"javascript:spar('"+next_engs+"',"+next_chap+","+next_sec+",'"+div_name+"')"+
                                noverhead+"\">&gt;</a></span> "+parallel+"<br/>";
                            */
                            var nword = word.split("\n");// [0].word變 nword(舊約split後會反序,不知為何)
                            var nexp = exp.split("\n");
                            if (N == 1) {//OT
                              var wid = 1;
                              console.log("nword length=" + nword.length);
                              for (var ii = 0; ii < nword.length; ii++) {
                                var t = nword[nword.length - ii - 1].split(" +"); // " +"是必須同時存在,不是其中1個符號存在即可.
                                if (t.length !== 1)
                                  console.dir("t.length=" + t.length);
                                head_str += "<div>";
                                for (var iii = 0; iii < t.length; iii++) {
                                  if (t[iii].indexOf(" ") == -1 && t[iii].indexOf("-") == -1) {
                                    // 大部分都不成立, 都是另1個.
                                    var sn = jsonObj.record[wid].sn;
                                    var wform = jsonObj.record[wid].wform;
                                    var orig = jsonObj.record[wid].orig;
                                    var remark = jsonObj.record[wid].remark;
                                    var exp1 = jsonObj.record[wid].exp;
                                    var par = encodeURIComponent(wform + '|' + orig + '|' + exp1 + '|' + remark + '|');
                                    head_str += "<span class=parsing N=1 k=" + sn + " par=" + par + ">";
                                    head_str += t[iii] + "&nbsp</span>";
                                    wid++;
                                  } else {
                                    var no_padding_str = t[iii];
                                    for (var index = t[iii].length - 1; ; index--) {
                                      if (t[iii].charAt(index) != " " && t[iii].charAt(index) != "\n") {
                                        // console.log(t[iii] + " index:"+index +" t[iii].length:"  +  t[iii].length);
                                        no_padding_str = t[iii].substr(0, index + 1);
                                        break;// 大部分是 t[iii].length-1, 第1個, 就是成立的(不是空白也不是\n)
                                      }
                                    }
                                    var start_pos = no_padding_str.search(/[^\u000A-\u0020]/); // 開始的符號(其中包含0x20空白, 回車0x10, 換行0x13
                                    // console.log("start_pos="+start_pos);
                                    do {
                                      try {
                                        var sn = jsonObj.record[wid].sn;
                                        var wform = jsonObj.record[wid].wform;
                                        var orig = jsonObj.record[wid].orig;
                                        var remark = jsonObj.record[wid].remark;
                                        var exp1 = jsonObj.record[wid].exp;
                                        var par = encodeURIComponent(wform + '|' + orig + '|' + exp1 + '|' + remark + '|');
                                      } catch (e) {
                                        console.log("e" + e)
                                      }
                                      head_str += "<span class=parsing N=1 k=" + sn + " par=" + par + ">";
                                      wid++;

                                      var next_s = no_padding_str.indexOf(" ", start_pos); // s: space
                                      var next_m = no_padding_str.indexOf("-", start_pos); // m:
                                      var str;
                                      if (next_m != -1 &&
                                        (next_s == -1 || next_m < next_s)) {
                                        // aaa-bbb ddd 這種 case. 或 aaa-bbb 這種case 先是'-'遇到.
                                        str = no_padding_str.substr(start_pos, next_m - start_pos);
                                        console.log(str + ".length=" + str.length);
                                        if (str.length == 1)
                                          console.log(str.charCodeAt(0));
                                        start_pos = next_m + 1;
                                        head_str += str + "-</span>";
                                      }
                                      else if (next_s != -1 &&
                                        (next_m == -1 || next_s < next_m)) {
                                        // aaa bbb-ddd 這種 case. 或 aaa bbb 這種case 先是' '遇到.
                                        str = no_padding_str.substr(start_pos, next_s - start_pos);
                                        console.log(str + ".length=" + str.length);
                                        if (str.length == 1)
                                          console.log(str.charCodeAt(0));

                                        start_pos = next_s + 1;
                                        head_str += str + "&nbsp</span>";//空白
                                      }
                                      else {
                                        console.log("m:" + next_m + " s:" + next_s);
                                        //end
                                        // aaa 這種case. 就是最後1個字了.
                                        str = no_padding_str.substr(start_pos, no_padding_str.length - start_pos);
                                        head_str += str + "</span>";
                                        break;
                                      }
                                      //console.log("next_s=" + next_s + " next_m=" + next_m + " str=" + str + " str.length=" + str.length);
                                    } while (next_m != -1 || next_s != -1);

                                    /*var s=t[iii].split(/[ -]/);
                                      console.log("s="+s);
                                    for(iiii=0;iiii<s.length;iiii++){
                                      var sn=jsonObj.record[wid].sn;
                                      var wform=jsonObj.record[wid].wform;
                                      var orig=jsonObj.record[wid].orig;
                                      var remark=jsonObj.record[wid].remark;
                                      var exp1=jsonObj.record[wid].exp;
                                      var par=encodeURIComponent(wform+'|'+orig+'|'+exp1+'|'+remark+'|');
                                      head_str+="<span class=parsing N=1 k="+sn+" par="+par+">";
                                      if(iiii==0)
                                        head_str+=s[iiii]+iiii+"&nbsp</span>";
                                      else
                                        head_str+=s[iiii]+iiii+"&nbsp</span>";
                                      wid++;
                                    }*/
                                  }
                                }
                                head_str += "</div>";
                                head_str += "<div>" + nexp[ii] + "</div>";
                              }
                            }
                            else if (N == 0) {
                              var wid = 1;
                              for (var ii = 0; ii < nword.length; ii++) {
                                nword[ii] = nword[ii].trim();
                                var t = nword[ii].split(" ");
                                head_str += "<div>";
                                for (var iii = 0; iii < t.length; iii++ , wid++) {
                                  var r1 = jsonObj.record[wid];  // 2017.12 馬可福音 1:34 原文
                                  if (r1 == null)
                                    continue;

                                  var sn = jsonObj.record[wid].sn;
                                  var pro = jsonObj.record[wid].pro;
                                  var wform = jsonObj.record[wid].wform;
                                  var orig = jsonObj.record[wid].orig;
                                  var remark = jsonObj.record[wid].remark;
                                  var exp1 = jsonObj.record[wid].exp;
                                  var par = encodeURIComponent(pro + '|' + wform + '|' + orig + '|' + exp1 + '|' + remark + '|');
                                  head_str += "<span class=parsing N=0 k=" + sn + " par=" + par + ">";
                                  head_str += t[iii] + "&nbsp</span>";
                                }
                                head_str += "</div>";
                                head_str += "<div>" + nexp[ii] + "</div>";
                              }
                            }
                          }// 以上是 wid = 0 的條件, 也就是處理上半部
                          else {
                            if (N == 0 && word == "+") {
                              /*
                                clrcnt=(clrcnt+1)%3;
                                if (clrcnt==0) clrstr="";
                                else if (clrcnt==1) clrstr="#ffff99";
                                else if (clrcnt==2) clrstr="#ffcccc";
                                msg=skip1tag(msg,"record");
                                */
                              continue;
                            }
                            var sn = jsonObj.record[i].sn;
                            var pro = jsonObj.record[i].pro;
                            var wform = jsonObj.record[i].wform;
                            var orig = jsonObj.record[i].orig;
                            var remark = jsonObj.record[i].remark;
                            var pt = remark.indexOf("[#");
                            var pt1 = remark.indexOf("#]");
                            while (N == 1 && pt >= 0 && pt1 > pt) {
                              var nstr = "";
                              var pstr = remark.substring(pt + 2, pt1);
                              pstr = pstr.replace(/１/g, "1");
                              pstr = pstr.replace(/２/g, "2");
                              pstr = pstr.replace(/３/g, "3");
                              pstr = pstr.replace(/４/g, "4");
                              pstr = pstr.replace(/５/g, "5");
                              pstr = pstr.replace(/６/g, "6");
                              pstr = pstr.replace(/７/g, "7");
                              pstr = pstr.replace(/８/g, "8");
                              pstr = pstr.replace(/９/g, "9");
                              pstr = pstr.replace(/．/g, ".");
                              subheb = pstr.split(",");
                              nstr = "§";
                              for (si = 0; si < subheb.length; si++) {
                                subheb[si] = subheb[si].trim();
                                if (subheb[si].length == 0) continue;
                                spt = subheb[si].split("-");
                                nstr = nstr + "<a href=\"/new/pimg/" + spt[0] + ".png\" target=\"grammer\">" + subheb[si] + "</a> ";
                              }
                              remark = remark.substring(0, pt) + nstr + remark.substring(pt1 + 2);
                              pt = remark.indexOf("[#");
                              pt1 = remark.indexOf("#]");
                            }
                            body_str = body_str + "<tr bgcolor=\"" + clrstr + "\"><td class=\"" + orig_font + "\">" + word + "</td><td class=\"g0\"><span class=\"parsingTableSn\" N=" + N + " k=" + sn + ">" + sn + "</span></td><td class=\"g0\">";
                            if (N == 0)
                              body_str = body_str + pro + "</td><td class=\"g0\">";
                            body_str = body_str + wform + "</td><td class=\"" + orig_font + "\">" + orig + "</td><td class=\"g0\">" + exp + "</td><td class=\"g0\">"
                              + remark + "</td></tr>";
                          }//else
                        }//for I
                        var ptg = "";
                        if (N == 0)
                          ptg = "<td class=\"g0\">詞性</td>";
                        var headDivStyle = "<div style=\"position: absolute; left: 0px; right: 0px; top: 0px; height: 200px; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; overflow:auto; padding: 30px 50px 10px; box-shadow: inset 0px -4px 7px #808080; font-size: 12pt; line-height: 18pt;" + ((N == 1) ? "text-align:right;" : "") +
                          "\">";

                        var html = chap_ctrl_str + headDivStyle + head_str + "</div><div id='parsingTable' style=\"position: absolute; top: 212px; left: 0px; right: 0px; bottom: 0px; padding: 10px; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; overflow:auto;box-shadow: inset 0px 4px 7px #808080;\"><table border=\"1\">" + "<tr><td class=\"g0\">原文字</td><td class=\"g0\">SN</td>" + ptg + "<td class=\"g0\">字彙分析</td><td class=\"g0\">原型</td><td class=\"g0\">原型簡義</td><td class=\"g0\">備註</td>" + body_str + "</table></div>";

                        html = "<div style='position: absolute; top: 200px; left: 0px; right: 0px; height: 12px; background: #A0A0A0;'></div>" + html + "";

                        dom.html(html);
                        that.registerEvents(ps);
                      }//if j
                    });
                    //tjm
                    break;
                  case "fhlInfoComment":
                    var html = "";
                    var ajaxUrl = getAjaxUrl("sc", ps);
                    //console.log(ajaxUrl);
                    $.ajax({
                      url: ajaxUrl
                    }).done(function (d, s, j) {
                      if (j) {
                        function parseComment(t) {
                          t = t.replace(/\n/g, "</br>");
                          t = t.replace(/ /g, "&nbsp");
                          var pt, pt1;
                          var tok, tok_str;
                          var span_str;
                          var i = 0;

                          // 2017.12 詩篇 30 篇 #30| 按下去會變 undefined Bug
                          FHL.STR.eachFitDo(/#([0-9]+)\|/, t, function (m1) {
                            //var replaceTag = '<span class="commentJump" engs="Ps" chap="30" sec="1">30</span>';
                            var chap = m1[1];
                            var replaceTag = '<span class="commentJump" engs="' + ps.engs + '" chap="' + chap + '" sec="1">' + chap + '</span>';
                            t = t.replace(m1[0], replaceTag);
                          });

                          while (true) {
                            pt = t.indexOf("#");
                            pt1 = t.indexOf("|");
                            if (pt < 0 || pt1 < 0 || pt1 <= pt)
                              break;
                            tok_str = t.substring(pt + 1, pt1);
                            span_str = "";

                            while (tok_str.length !== 0) {
                              var firstTokEnd = tok_str.indexOf(";");
                              if (firstTokEnd === -1)
                                firstTokEnd = tok_str.length;
                              tok = tok_str.substring(0, firstTokEnd);
                              tok_str = tok_str.substring(firstTokEnd + 1, tok_str.length);

                              span_str += "&nbsp;<span class='commentJump' engs=";
                              var secNumberEnd = tok.indexOf("-");
                              if (secNumberEnd === -1)
                                secNumberEnd = tok.length;
                              var chapNumberEnd = tok.indexOf(":");
                              var secNumber = tok.substring(chapNumberEnd + 1, secNumberEnd);
                              if (!isNaN(tok[0])) { // parse 在同一卷書裡面跳的
                                var chapNumber = tok.substring(0, chapNumberEnd);
                                span_str += ps.engs;
                              }
                              else { // parse 有中文字在前面的
                                var bookNameEnd = tok.indexOf("&nbsp");
                                var bookName = tok.substring(0, bookNameEnd);
                                var chapNumber = tok.substring(bookNameEnd + 5, chapNumberEnd);//+5是因為&nbsp
                                span_str += bookEng[book.indexOf(bookName)];
                              }
                              span_str += " chap=" + chapNumber + " sec='" + secNumber + "'>" + tok + "</span>&nbsp;";
                            }
                            t = t.substring(0, pt) + span_str + t.substring(pt1 + 1);
                          }

                          // 2017.12
                          var tmp = t
                          FHL.STR.eachFitDo(/SNH([0-9]+)/, tmp, function (m1) {
                            var sn = m1[1];
                            // var newTag = '<span class="sn" sn="09001">09001</span>'
                            var newTag = '<span class="sn" sn="' + sn + '">' + sn + '</span>';
                            t = t.replace(m1[0], newTag);
                          });
                          tmp = t
                          FHL.STR.eachFitDo(/SNG([0-9]+)/, tmp, function (m1) {
                            var sn = m1[1];
                            // var newTag = '<span class="sn" sn="09001">09001</span>'
                            var newTag = '<span class="sn" sn="' + sn + '">' + sn + '</span>';
                            t = t.replace(m1[0], newTag);
                          });

                          return t;
                        }

                        var jsonObj = JSON.parse(j.responseText);
                        var prev_engs;
                        var prev_chap;
                        var prev_sec;
                        var next_engs;
                        var next_chap;
                        var next_sec;
                        var head_str = "";
                        var control_str = "";
                        if (jsonObj.status === "success" && jsonObj.record_count !== 0) {

                          //console.log("display");

                          if (jsonObj.hasOwnProperty('prev') && !(jsonObj.prev.chap == 0 && jsonObj.prev.sec == 0)) {
                            prev_engs = jsonObj.prev.engs;
                            prev_chap = jsonObj.prev.chap;
                            prev_sec = jsonObj.prev.sec;
                            control_str += "<div class='commentSecBack' ";
                            control_str += "engs='" + prev_engs + "' chap=" + prev_chap + " sec=" + prev_sec;
                            control_str += "><span>&#x276e;</span></div>";
                          }

                          if (jsonObj.hasOwnProperty('next') && ps.chap != 0 && ps.sec != 0) {
                            next_engs = jsonObj.next.engs;
                            next_chap = jsonObj.next.chap;
                            next_sec = jsonObj.next.sec;
                            control_str += "<div class='commentSecNext' ";
                            control_str += "engs='" + next_engs + "' chap=" + next_chap + " sec=" + next_sec;
                            control_str += "><span>&#x276f;</span></div>";
                          }

                          head_str += "<div id='commentTitle'>";
                          if (ps.chap != 0 && ps.sec != 0) {
                            head_str += jsonObj.record[0].title;
                            head_str += "</div>"
                            head_str += "<div class='commentBackground' ";
                            head_str += "engs='" + ps.engs + "' chap=" + 0 + " sec=" + 0;
                            head_str += ">書卷背景</div>";
                          }
                          else {
                            var idx = getBookFunc('indexByEngs', ps.engs);
                            head_str += bookFullName[idx] + "&nbsp;背景資料";
                            head_str += "</div>"
                            head_str += "<div class='commentBackground' ";
                            head_str += "engs='" + ps.engs + "' chap=" + 0 + " sec=" + 0;
                            head_str += ">返回註釋</div>";
                          }


                          var html = jsonObj.record[0].com_text; //注釋內文

                          html = parseComment(html);
                          html = "<div style='position: static; padding: 0px; top: 0px; bottom: 0px; overflow: auto;'>" + head_str + '<div id="commentContent">' + control_str + "<div id='commentScrollDiv' style='position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; padding: 80px 10px 70px; overflow: auto;'>" + html + "</div></div></div>";
                          dom.html(html);
                        }
                        else {
                          dom.html("<div style='position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); '>施工中...</div>");
                        }
                        that.registerEvents(ps);
                      }

                    });
                    break;
                  case "fhlInfoPreach":
                    do_preach(ps, dom);
                    break;
                  case "fhlInfoTsk":
                    // 串珠 snow
                    {
                      var dom2 = document.getElementById("fhlInfoContent");
                      if (dom2 != null) {
                        var pfn_search_sn = function (sn) {
                          doSearch(sn, ps, false);
                        };

                        var jret = tsk.tskapi(ps.engs, ps.chap, ps.sec, ps.gb ? true : false);
                        var r = React.createElement(tsk.R.frame, {
                          txt_ori: jret.record[0].com_text,
                          default_book: ps.engs,
                          default_version: "unv",
                          isSN: ps.strong == 1 ? true : false,
                          isGB: ps.gb ? true : false,
                          cy: $(dom2).height(),
                          pfn_search_sn: pfn_search_sn //指定按下sn的結果
                        });
                        React.render(r, dom2);
                        var renderobj = React.render(r, dom2);
                      }
                    }
                    //dom.html("<div style='position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); '>施工中...</div>");
                    break;
                  case "fhlInfoOb":
                    // 典藏 snow
                    var dom2 = document.getElementById("fhlInfoContent");
                    if (dom2 != null) {
                      var rProp = {
                        ibook: getBookFunc("indexByEngs", ps.engs),
                        ichap: ps.chap,
                        isec: ps.sec,
                        isgb: ps.gb ? true : false,
                        cy: $(dom2).height()
                      };
                      var r = React.createElement(obphp.R.frame, rProp);// r:react Ob:(Old Bible) Frame
                      var renderobj = React.render(r, dom2);
                    }
                    break;
                  case "fhlInfoAudio":

                    // 有聲聖經 snow
                    {
                      var pfn_callback = function fn_after_set(ibook, ichap) {
                        ps.chineses = book[idx];
                        ps.chap = ichap + 1; //因為是0-based 與 1-based
                        ps.sec = 1;
                        bookSelect.render(pageState, bookSelect.dom);
                        fhlLecture.render(pageState, fhlLecture.dom);
                        fhlInfo.render(pageState);
                      };
                      var idx = getBookFunc("index", ps.chineses); // 0-based

                      // add 2015.12.10(四) snow, 若是沒加這個條件, (前兩個, 點到節的時候會重播...但根本是同一章,不該重播), (第3個...若只加前2個條件, 不加第3個, 在從其它功能(例如典藏...切回來有聲...就不會render了)
                      if (audiobible.g_audiobible.m_ibook != idx || audiobible.g_audiobible.m_ichap != ps.chap - 1 || ps.titleId != ps.titleIdold) {
                        //ps.chap; // 1-based
                        audiobible.g_audiobible.set_book_chap(idx, ps.chap - 1, dom[0]);
                        audiobible.g_audiobible.m_pfn_after_set = pfn_callback;
                      }
                    }
                    break;
                  case "fhlInfoMap":
                    // 地圖 map
                    fhlmap_render(ps, dom);
                    // dom.html("<div style='position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); '>施工中...</div>");
                    break;
                }
                fhlmap_titleId_prev = ps.titleId; //地圖 map 會用到, 因為切換走分頁, 再切換回來要 re-create render object. see also: fhlmap_render
              }
            };

            function parseDic(text) {
              var ps = pageState;
              text = text.replace(/(定義|自希伯來文|於|自|參|與|同義詞|和|見|from|and|See|see entry)(\s+)/g,
                function replacer(match, p1, offset, string) { return p1; });
              text = text.replace(/ /g, "&nbsp;");
              text = text.replace(/(於|自|參|與|同義詞|和|見|from|and|See|see entry)(\d+)/g,
                function replacer(match, p1, p2, offset, string) {
                  return p1 + "<span class='snParse' N=" + ps.N + ">" + p2 + "</span>";
                });
              text = text.replace(/自希伯來文(\d+)/g, function replacer(match, p1, offset, string) {
                return "自希伯來文<span class='snParse' N=1>" + p1 + "</span>";
              });
              text = text.replace(/定義(\d+)/g, function replacer(match, p1, offset, string) {
                return "定義<span class='snParse' N=" + ps.N + ">" + p1 + "</span>";
              });
              text = text.replace(/#(.*?)\|/g, function replacer(match, p1, offset, string) {
                return "<span class='searchBibleVerse'>" + p1 + "</span>";
              });
              text = text.replace(/\r\n/g, "</br>");
              return text;
            }

            var parsingPopUp = {
              init: function (ps, dom) {
                this.dom = dom;
                this.dom.hide();
              },
              registerEvents: function (ps) {
                var that = this;

                this.dom.on("mousedown", function (e) {
                  if (e.which == 3)
                    $(this).addClass("right");
                }).on("mouseleave", function (e) {
                  if (!$(this).hasClass("right"))
                    that.dom.hide();
                }).on("mouseenter", function (e) {
                  clearTimeout($.data($('#parsingPopUp')[0], "parsingPopUpAutoCloseTimeout"));
                  if ($(this).hasClass("right"))
                    setTimeout(function () { $('#parsingPopUp').removeClass("right"); }, 1);
                });

                $('.snParse').click(function () {
                  //var offset=parsingPopUp.dom.offset;
                  ps.N = $(this).attr('N');
                  ps.k = $(this).html();
                  parsingPopUp.render(ps, parsingPopUp.dom, null);
                });
                $('.searchBibleVerse').click(function () {
                  var searchText = $(this).html();
                  searchText = searchText.replace(/&nbsp;/g, " ");
                  searchText = "#" + searchText + "|";

                  // replace 2015.08.01(六)
                  doSearch(searchText, ps);

                  // mark 2015.08.01(六)
                  // doSearch("#" + searchText + "|", "search", 0);
                });

                $('.searchSN').click(function () {
                  if (!$('#fhlMidBottomWindowControl').hasClass('selected')) {
                    $('#fhlMidBottomWindowControl').trigger("click");
                  }
                  var keywords = $(this).attr('k'); // sn
                  //keywords = '3478'; //example;

                  //replace 2015.08.01(六)
                  doSearch(keywords, ps, false);

                  // mark 2015.08.01(六)
                  //doSearch($(this).attr('k'),"search",parseInt($(this).attr('N'))+1);
                });
              },
              render: function (ps, dom, offset, par) {
                var that = this;
                if (par == "ft") {
                  var html = '<div id="parsingPopUpTriangle"></div><div id="parsingPopUpInside">' + "取得資料中..." + '</div>';
                  dom.html(html);
                  var winH = $(window).height();
                  var domH = (that.dom.height() > 200) ? 200 + 30 : that.dom.height();

                  if (offset != null) {
                    if (offset.top + domH + 12 + 15 > winH) {
                      offset.top -= domH + 40;
                      offset.left -= 40;
                      $("#parsingPopUpTriangle").addClass("parsingPopUpLowerTriangle");
                    }
                    else {
                      offset.top += 0;
                      offset.left -= 40;
                      $("#parsingPopUpTriangle").addClass("parsingPopUpUpperTriangle");
                    }
                  }

                  that.dom.show();
                  dom.offset(offset);
                  that.registerEvents(ps);
                }
                else if (par == "psn") {
                  var ajaxUrl = getAjaxUrl('sd', ps);
                  $.ajax({
                    url: ajaxUrl
                  }).done(function (d, s, j) {
                    var jsonObj = JSON.parse(j.responseText);
                    var html = jsonObj.record[0].dic_text;
                    html = parseDic(html);


                    html = '<div id="parsingPopUpTriangle"></div><div id="parsingPopUpInside">' + html + '</div>';
                    dom.html(html);
                    var winH = $(window).height();
                    var domH = (that.dom.height() > 200) ? 200 + 40 : that.dom.height();
                    whenoverwindow_offset_modified();
                    if (offset != null) {
                      if (offset.top + domH + 12 + 15 > winH) {
                        offset.top -= domH + 40;
                        offset.left -= 40;
                        $("#parsingPopUpTriangle").addClass("parsingPopUpLowerTriangle");
                      }
                      else {
                        offset.top += 0;
                        offset.left -= 40;
                        $("#parsingPopUpTriangle").addClass("parsingPopUpUpperTriangle");
                      }
                      that.dom.show();
                      dom.offset(offset);
                    }

                    /*dom.html(html);
                    if(offset!=null){
                      var lecTop=164;
                      var lecTopOffset=120;
                      var RightWinH=$('#fhlInfo').height();
                      var domH=dom.height();
                    //console.log("top:"+offset.top+",domH:"+domH+",RightWinH:"+RightWinH);

                      if(domH>RightWinH){
                        //set css to auto scroll
                      }else if(offset.top+domH>RightWinH){
                        offset.top-=(offset.top>domH)?domH:offset.top;
                        offset.left+=70;
                      }
                      that.dom.show();
                      dom.offset(offset);
                    }        */
                    that.registerEvents(ps);
                  });
                } else if (par != null) {
                  var html = par;
                  dom.html(html);
                  that.dom.show();
                  if (offset != null) {
                    dom.offset(offset);
                  }
                  //that.dom.scrollTop(0);
                  that.registerEvents(ps);
                } else {
                  var ajaxUrl = getAjaxUrl('sd', ps);
                  $.ajax({
                    url: ajaxUrl
                  }).done(function (d, s, j) {
                    var jsonObj = JSON.parse(j.responseText);

                    // replace 2015.10.29(四) snow
                    // 使用 j.responseText 的 .sn=00430, 但顯示是 0430, 要用 0430作為關鍵字, 才會被畫上藍色, 因為00430不等於0430 (snow) 2015.10.29(四)
                    // 因此. 出現經文按下去的時候. 若是k=00430, 就不會有正確的畫出藍色
                    // "record":[{"sn":"00430","dic_text":"0430  ... 這是 j.responseText 局部
                    var snShow = /[0-9]+/.exec(jsonObj.record[0].dic_text); //add 2015.10.29(四)
                    var title = "";
                    if (snShow == null)
                      title = "<span class='searchSN' N=" + jsonObj.record[0].dic_type + " k=" + jsonObj.record[0].sn + ">";//原本的
                    else
                      title = "<span class='searchSN' N=" + jsonObj.record[0].dic_type + " k=" + snShow[0] + ">";
                    //var title="<span class='searchSN' N="+jsonObj.record[0].dic_type+" k="+jsonObj.record[0].sn+">"; //mark 2015.10.29(四) snow
                    title += "出現經文</span></br>";
                    var html = jsonObj.record[0].dic_text;
                    html = parseDic(html);
                    html = '<div id="parsingPopUpTriangle"></div><div id="parsingPopUpInside">' + title + html + '</div>';
                    dom.html(html);
                    var winH = $(window).height();
                    var domH = (that.dom.height() > 200) ? 200 + 40 : that.dom.height();
                    //whenoverwindow_offset_modified();
                    if (offset != null) {
                      if (offset.top + domH + 12 + 15 > winH) {
                        offset.top -= domH + 30;
                        offset.left -= 40;
                        $("#parsingPopUpTriangle").addClass("parsingPopUpLowerTriangle");
                      }
                      else {
                        offset.top += 10;
                        offset.left -= 40;
                        $("#parsingPopUpTriangle").addClass("parsingPopUpUpperTriangle");
                      }
                      that.dom.show();
                      dom.offset(offset);
                    }
                    that.registerEvents(ps);
                  });
                }
              }
            };
            /***** End of fhlInfo *****/
  </script>
  <!--Start of 搜尋功能-->
  <script>
            var searchTool = {
              init: function (ps, dom) {
                this.dom = dom;
                this.render(ps, this.dom);
              },
              registerEvents: function (ps) {
                var that = this;

                var $searchTrigger = $('[data-ic-class="search-trigger"]'),
                  $searchInput = $('[data-ic-class="search-input"]'),
                  $searchClear = $('[data-ic-class="search-clear"]');

                $searchTrigger.click(function () {
                  var $this = $('[data-ic-class="search-trigger"]');
                  $this.addClass('active');
                  $searchInput.focus();
                });

                $searchInput.blur(function () {
                  if ($searchInput.val().length > 0) {
                    return false;
                  } else {
                    $searchTrigger.removeClass('active');
                  }
                });

                $searchClear.click(function () {
                  $searchInput.val('');
                });

                $searchInput.focus(function () {
                  $searchTrigger.addClass('active');
                });

                $('.searchBtn').click(function () {
                  //ps.leftBtmWinShow = true;
                  setPageState(ps);
                  fhlMidBottomWindow.render(ps, fhlMidBottomWindow.dom);
                  //doSearch($('.searchBox').val(),"search",0);
                  doSearch($('.searchBox').val(), ps);
                  $searchInput.val('');
                  $searchInput.blur();
                  $searchTrigger.removeClass('active');
                  if (!$('#fhlMidBottomWindowControl').hasClass('selected')) {
                    $('#fhlMidBottomWindowControl').trigger("click");
                  }
                });
              },
              render: function (ps, dom) {
                var html = "";/*&#x1f50d;*/
                html += ' <div class="wrapper">\
                                  <div class="icon-search-container" data-ic-class="search-trigger">\
                                    <span class="search"><i class="fa fa-search fa-fw"></i></span>\
                                    <input type="text" class="searchBox search-input" data-ic-class="search-input" placeholder="Search" on/>\
                                    <span class="times-circle" data-ic-class="search-clear">×</span>\
                                  </div>\
                                  <span class="searchBtn">快速搜尋</span>\
                                </div>'
                dom.html(html);
              }
            };
            function doSearch(keyword, ps, isAll) {
              /// <summary> 新版本 (2015.08.01, 搜尋</summary>
              /// <param type="string" name="keyword" parameterArray="false">Ex: #賽 21:1| or 3478 or 當把</param>
              /// <param type="bool" name="isAll" parameterArray="false">SN搜尋的時候,它若是在新約的時候,click,就只找新約,default:true</param>
              $('#fhlMidBottomWindowTitle').html('搜尋：' + keyword);
              if (isAll == undefined)
                isAll = true;

              sephp.act_sn_button_click = function (pdata) {
                //console.log('ex: {engs: "Dan",keyword: "03478",ver: "unv"}');
                $('.searchBox').val(pdata.data.keyword);
              };

              // 2015.07.29(三)
              sephp.act_ref_button_click = function (pdata) {
                /// <summary> 會傳入 engs, chap, sec, ver 資訊. 通常是用來切換章節</summary>
                // console.log("act_ref_button_click not assign., 會傳入 engs, chap, sec, ver 資訊. 通常是用來切換章節");
                var idx = getBookFunc("indexByEngs", pdata.data.engs);
                ps.chineses = book[idx];
                ps.engs = bookEng[idx];
                ps.chap = pdata.data.chap;
                ps.sec = pdata.data.sec;
                setPageState(ps);
                bookSelect.render(pageState, bookSelect.dom);
                fhlLecture.render(pageState, fhlLecture.dom);
                fhlLecture.selectLecture(ps.engs, ps.chap, ps.sec);
                fhlInfo.render(pageState);
              }; //設定按下查詢之後的空白圓圈圈要作的事

              var issn = false;
              if (ps.strong == 1)
                issn = true;
              var isgb = false;
              if (ps.gb == 1)
                isgb = true;
              sephp.node_pre_search = document.getElementById("pre_search");
              sephp.node_search_result = document.getElementById("search_result");
              sephp.search(keyword, issn, isgb, ps.version, ps.engs, isAll);

              {//卷軸與介面.2015.07.29(三)
                //console.log($('#fhlMidBottomWindowContent').width());
                //console.log($('#fhlMidBottomWindowContent').height());
                //$(sephp.node_pre_search).width($('#fhlMidBottomWindowContent').width());
                //$(sephp.node_search_result).height($('#fhlMidBottomWindowContent').height() - $(sephp.node_pre_search).height());
                //$(sephp.node_search_result).css("overflow-y", "scroll");
                $('#pre_search').scroll(function () {
                  $(this).addClass('scrolling');
                  clearTimeout($.data(this, "scrollCheck"));
                  $.data(this, "scrollCheck", setTimeout(function () {
                    $('#pre_search').removeClass('scrolling');
                  }, 350));
                });
                $('#search_result').scroll(function () {
                  $(this).addClass('scrolling');
                  clearTimeout($.data(this, "scrollCheck"));
                  $.data(this, "scrollCheck", setTimeout(function () {
                    $('#search_result').removeClass('scrolling');
                  }, 350));
                });
              }//卷軸與介面.
            }
  </script>
  <!--講道功能 2015.05.11-->
  <script>
            var rRender_Preach;
            var r_Preach;
            var onset_Preach = function (engs, chap, sec) {
              //console.log("外部onset");
              rRender_Preach.setProps({ "engs": engs, "chap": chap, "sec": sec });
            };
            function do_preach(ps, dom) {
              var dom2 = document.getElementById("fhlInfoContent");
              if (dom2 != null) {
                r_Preach = React.createElement(preach_api.R.frame, {
                  "engs": ps.engs,
                  "chap": ps.chap,
                  "sec": ps.sec,
                  "onset": onset_Preach
                });
                rRender_Preach = React.render(r_Preach, dom2);
              }




              //// 設定 callback function (scphp.set會呼叫)
              //scphp.pfn_set_after = function pfn_set_after(rediv) {
              //  dom.html(rediv);

              //  // 四個樣式可設定 (可變更...現在只是隨便設)
              //  //for (var idx in scphp.divbooknames)//主題
              //  //  $(scphp.divbooknames[idx]).addClass("search_type");
              //  //for (var idx in scphp.divtitles)//範圍
              //  //  $(scphp.divtitles[idx]).addClass("search_type");
              //  for (var idx in scphp.divnexts)//範圍
              //    $(scphp.divnexts[idx]).addClass("search_type");
              //  for (var idx in scphp.divprevs)//範圍
              //    $(scphp.divprevs[idx]).addClass("search_type");
              //}; // 設定 callback function (scphp.set會呼叫)

              //// 設定 callback function (onclick時會呼叫)
              //scphp.pfn_goto_sec = function pfn_(engs, chap, sec) {
              //  var idx = getBookFunc("indexByEngs", engs);
              //  ps.chineses = book[idx];
              //  ps.engs = engs;
              //  ps.chap = chap;
              //  ps.sec = sec;
              //  bookSelect.render(pageState, bookSelect.dom);
              //  fhlLecture.render(pageState, fhlLecture.dom);
              //  fhlInfo.render(pageState);
              //}; // 設定 callback function (onclick時會呼叫)

              //scphp.set(ps.engs, ps.chap, ps.sec);
            }//do_preach
  </script><!--講道功能 2015.05.11-->
  <style>
    img.pos {
      background-image: url('static/images/site.png');
      min-width: 12px;
      min-height: 22px;
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center center;
      cursor: pointer;
    }

    img.pho {
      background-image: url('static/images/camera.png');
      min-width: 29px;
      min-height: 22px;
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center center;
      cursor: pointer;
    }

    @font-face {
      font-family: 'COBSGreekWeb';
      src: url('static/font/COBSGreekWeb.ttf') format('truetype');
    }
  </style>
</head>
<body>
  <div id="app">
    <app></app>
  </div>

</body>
</html>
